<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loyalty App</title>
    
    <!-- Core Dependencies -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- DYNAMIC THEME ENGINE (SaaS) --- */
        :root {
            /* –ë–∞–∑–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ (–±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã JS) */
            --theme-color: #F59E0B; /* Amber-500 */
            --theme-bg: #FFFBEB;    /* Amber-50 */
            --theme-text: #B45309;  /* Amber-700 */
        }

        /* –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ü–≤–µ—Ç–æ–≤ */
        .bg-theme { background-color: var(--theme-color) !important; }
        .bg-theme-soft { background-color: var(--theme-bg) !important; }
        .text-theme { color: var(--theme-color) !important; }
        .text-theme-dark { color: var(--theme-text) !important; }
        .border-theme { border-color: var(--theme-color) !important; }
        .shadow-theme { --tw-shadow-color: var(--theme-color) !important; }
        .ring-theme { --tw-ring-color: var(--theme-color) !important; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #F9FAFB;
        }

        .page {
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), opacity 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: #F9FAFB;
            display: none;
        }
        
        .page.active {
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .stamp-enter { animation: stamp-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes stamp-pop {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-900 h-screen overflow-hidden relative">

    <!-- === LOADER === -->
    <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-gray-200 border-t-gray-800 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-400 text-sm font-medium animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ–¥–µ–Ω–∏—è...</p>
    </div>

    <!-- === ERROR SCREEN === -->
    <div id="view-error" class="hidden fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-8 text-center">
        <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-4">
            <i data-lucide="wifi-off" class="w-8 h-8"></i>
        </div>
        <h2 class="text-xl font-bold mb-2">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏</h2>
        <p class="text-gray-500 mb-6">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.</p>
        <button onclick="window.location.reload()" class="px-6 py-3 bg-gray-900 text-white rounded-xl font-bold active:scale-95 transition-transform">
            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
        </button>
    </div>

    <!-- === DESKTOP STUB === -->
    <div id="stub-view" class="hidden fixed inset-0 z-[60] bg-gray-50 flex flex-col items-center justify-center p-6 text-center">
        <i data-lucide="smartphone" class="w-16 h-16 text-gray-300 mb-4"></i>
        <h2 class="text-xl font-bold mb-2">–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</h2>
        <p class="text-gray-500">–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram.</p>
    </div>

    <!-- ================= VIEWS ================= -->

    <!-- 1. HOME VIEW -->
    <div id="view-home" class="page px-5 py-6">
        <!-- Brand Header (SaaS) -->
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
                <img id="app-logo" src="" alt="Logo" class="w-12 h-12 rounded-full object-cover border-2 border-gray-100 shadow-sm bg-white">
                <div>
                    <h1 id="app-title" class="text-xl font-black text-gray-800 tracking-tight leading-tight">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                    <p id="user-name" class="text-xs text-gray-500 font-medium">–ü—Ä–∏–≤–µ—Ç, –ì–æ—Å—Ç—å!</p>
                </div>
            </div>
            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center overflow-hidden">
                <i data-lucide="user" class="w-5 h-5 text-gray-400"></i>
            </div>
        </header>

        <!-- Stats Card (SaaS Styled) -->
        <div class="bg-gray-900 rounded-3xl p-6 text-white shadow-xl shadow-gray-200 mb-6 relative overflow-hidden group">
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-theme opacity-20 rounded-full blur-3xl group-hover:opacity-30 transition-opacity"></div>
            
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">–í–∞—à —Å—Ç–∞—Ç—É—Å</p>
                        <p id="user-rank" class="text-2xl font-bold text-theme">–ì–æ—Å—Ç—å</p>
                    </div>
                    <div class="text-right">
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">–ü—Ä–æ–≥—Ä–µ—Å—Å</p>
                        <p class="text-2xl font-bold">
                            <span id="user-balance">0</span>
                            <span class="text-gray-500 text-lg">/<span id="target-count-display">6</span></span>
                        </p>
                    </div>
                </div>

                <div class="bg-white/10 rounded-2xl p-4 flex justify-between items-center backdrop-blur-md border border-white/5">
                    <span class="text-sm font-medium text-gray-300">–î–æ –±–æ–Ω—É—Å–∞ <span id="reward-name-display">...</span>:</span>
                    <span id="stamps-left" class="font-bold text-theme text-xl">0</span>
                </div>
            </div>
        </div>

        <!-- Bonuses Button (Restored from v2) -->
        <button onclick="Router.go('bonuses')" class="w-full mb-6 py-4 bg-theme-soft border border-theme/20 rounded-2xl flex items-center justify-between px-6 active:scale-95 transition-transform group">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-theme text-white rounded-full flex items-center justify-center shadow-lg shadow-theme/30">
                    <i data-lucide="gift" class="w-5 h-5"></i>
                </div>
                <div class="text-left">
                    <p class="font-bold text-gray-800">–ú–æ–∏ –±–æ–Ω—É—Å—ã</p>
                    <p class="text-xs text-theme-dark font-medium" id="home-bonus-count">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö</p>
                </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 group-hover:text-theme transition-colors"></i>
        </button>

        <!-- Menu Grid -->
        <div class="grid grid-cols-2 gap-4">
            <button onclick="Router.go('card')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform">
                <div class="w-12 h-12 bg-gray-50 text-gray-600 rounded-full flex items-center justify-center">
                    <i data-lucide="credit-card" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-gray-700">–ú–æ—è –∫–∞—Ä—Ç–∞</span>
            </button>

            <!-- QR Action -->
            <button onclick="Router.go('qr', 'EARN')" class="bg-theme p-5 rounded-2xl shadow-lg shadow-theme/30 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform text-white">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                    <i data-lucide="qr-code" class="w-6 h-6"></i>
                </div>
                <span class="font-bold">–ü–æ–∫–∞–∑–∞—Ç—å QR</span>
            </button>

            <button onclick="Router.go('contacts')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform">
                <div class="w-12 h-12 bg-gray-50 text-gray-600 rounded-full flex items-center justify-center">
                    <i data-lucide="phone" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-gray-700">–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
            </button>

            <button onclick="Router.go('help')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform">
                <div class="w-12 h-12 bg-gray-50 text-gray-600 rounded-full flex items-center justify-center">
                    <i data-lucide="help-circle" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-gray-700">–ü–æ–º–æ—â—å</span>
            </button>
        </div>
        
        <div class="mt-8 text-center">
            <p class="text-xs text-gray-400">–í—Å–µ–≥–æ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ: <span id="total-stamps" class="font-bold text-gray-600">0</span></p>
        </div>
    </div>

    <!-- 2. BONUSES VIEW (Restored from v2 + SaaS Styled) -->
    <div id="view-bonuses" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center mb-8">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900 active:scale-90 transition-transform">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="text-xl font-bold ml-2">–ú–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
        </div>

        <div class="flex-1 flex flex-col items-center">
            <!-- Rank Card -->
            <div class="w-full bg-gray-900 text-white rounded-2xl p-6 shadow-xl mb-6 flex justify-between items-center">
                <div>
                    <p class="text-gray-400 text-xs mb-1">–í–∞—à —Å—Ç–∞—Ç—É—Å</p>
                    <h3 id="bonus-rank" class="text-2xl font-bold text-theme">–ù–æ–≤–∏—á–æ–∫</h3>
                </div>
                <div class="text-4xl">üèÜ</div>
            </div>

            <!-- Available Bonuses Big -->
            <div class="w-full bg-theme-soft border border-theme/20 rounded-3xl p-8 text-center mb-auto flex flex-col items-center justify-center">
                <div class="w-20 h-20 bg-white text-theme rounded-full flex items-center justify-center mb-4 shadow-sm">
                    <i data-lucide="gift" class="w-10 h-10"></i>
                </div>
                <p class="text-theme-dark font-medium mb-2">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</p>
                <div class="text-6xl font-black text-theme mb-4" id="bonus-cups-display">0</div>
                <p class="text-xs text-gray-500 max-w-[200px]">–ü–æ–∫–∞–∂–∏—Ç–µ QR –∫–æ–¥ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞—Ä–∏—Å—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</p>
            </div>

            <!-- Use Bonus Button -->
            <button id="btn-use-bonus" onclick="Router.go('qr', 'REDEEM')" class="w-full py-4 bg-theme text-white text-lg font-bold rounded-xl shadow-lg shadow-theme/30 active:scale-95 transition-transform disabled:opacity-50 disabled:grayscale flex items-center justify-center gap-2">
                <i data-lucide="qr-code" class="w-5 h-5"></i>
                –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å
            </button>
        </div>
    </div>

    <!-- 3. MY CARD VIEW (SaaS Styled) -->
    <div id="view-card" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center mb-8">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900 active:scale-90 transition-transform">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="text-xl font-bold ml-2">–ë–æ–Ω—É—Å–Ω–∞—è –∫–∞—Ä—Ç–∞</h2>
        </div>

        <div class="bg-white rounded-3xl p-6 shadow-xl shadow-gray-100 border border-gray-100 flex-1 flex flex-col items-center">
            <div class="text-center mb-8">
                <h3 class="text-lg font-bold text-gray-800" id="card-desc">–°–æ–±–∏—Ä–∞–π—Ç–µ —à—Ç–∞–º–ø—ã!</h3>
                <p class="text-gray-400 text-sm mt-1">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–µ</p>
            </div>

            <div id="stamps-container" class="grid grid-cols-3 gap-4 w-full mb-auto place-items-center">
                <!-- Stamps injected by JS -->
            </div>
            
            <button onclick="Router.go('qr', 'EARN')" class="w-full py-4 mt-8 bg-gray-900 text-white font-bold rounded-xl active:scale-95 transition-transform shadow-lg">
                –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å
            </button>
        </div>
    </div>

    <!-- 4. QR CODE VIEW -->
    <div id="view-qr" class="page px-6 py-6 flex flex-col bg-gray-900 text-white">
        <div class="flex items-center mb-6">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-white active:scale-90 transition-transform">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 class="text-xl font-bold ml-2" id="qr-view-title">–ü–æ–∫–∞–∂–∏—Ç–µ –±–∞—Ä–∏—Å—Ç–∞</h2>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center">
            <div id="qr-view-hint" class="mb-6 px-4 py-2 bg-white/10 rounded-lg text-sm font-medium text-center backdrop-blur-md">...</div>

            <div class="bg-white p-5 rounded-3xl shadow-2xl mb-8 relative">
                <div id="qrcode"></div>
                <!-- Expired Overlay -->
                <div id="qr-expired" class="hidden absolute inset-0 bg-white/95 flex flex-col items-center justify-center rounded-3xl text-center p-4">
                    <i data-lucide="refresh-cw" class="w-8 h-8 text-gray-400 mb-2"></i>
                    <p class="text-gray-900 font-bold mb-2">–ö–æ–¥ –∏—Å—Ç–µ–∫</p>
                    <button onclick="QRManager.generate()" class="text-theme text-sm font-bold">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>

            <p class="text-gray-400 text-sm mb-4">–ö–æ–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
            
            <div class="w-full max-w-[200px] h-1 bg-gray-800 rounded-full overflow-hidden">
                <div id="timer-bar" class="h-full bg-theme transition-all duration-1000 ease-linear" style="width: 100%"></div>
            </div>
        </div>
    </div>

    <!-- 5. SUCCESS VIEW -->
    <div id="view-success" class="page px-6 py-6 flex flex-col items-center justify-center bg-theme-soft">
        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-6 shadow-lg shadow-theme/20 stamp-enter text-theme">
            <i data-lucide="check" class="w-12 h-12"></i>
        </div>
        <h2 id="success-title" class="text-2xl font-black text-gray-900 mb-2">–û—Ç–ª–∏—á–Ω–æ!</h2>
        <p id="success-message" class="text-gray-600 text-center mb-12">...</p>
        <button onclick="Router.go('home')" class="w-full py-4 bg-white text-gray-900 font-bold rounded-xl shadow-sm active:scale-95 transition-transform">
            –í –º–µ–Ω—é
        </button>
    </div>

    <!-- 6. CONTACTS & HELP (Standard) -->
    <div id="view-contacts" class="page px-6 py-6">
        <div class="flex items-center mb-8">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
        </div>
        <div class="space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-10 h-10 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                <div><p class="text-sm text-gray-400">–ê–¥—Ä–µ—Å</p><p class="font-bold">–£—Ç–æ—á–Ω—è–π—Ç–µ —É –±–∞—Ä–∏—Å—Ç–∞</p></div>
            </div>
            <a href="https://t.me/support" class="block bg-theme text-white p-4 rounded-xl text-center font-bold mt-8 shadow-theme/30 shadow-lg">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</a>
        </div>
    </div>

    <div id="view-help" class="page px-6 py-6">
        <div class="flex items-center mb-8">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</h2>
        </div>
        <div class="prose text-gray-600">
            <ul class="space-y-4">
                <li class="flex gap-3"><span class="font-bold text-gray-900">1.</span> –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∫ –Ω–∞–º.</li>
                <li class="flex gap-3"><span class="font-bold text-gray-900">2.</span> –ù–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å QR".</li>
                <li class="flex gap-3"><span class="font-bold text-gray-900">3.</span> –ü–æ–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –±–∞—Ä–∏—Å—Ç–∞.</li>
                <li class="flex gap-3"><span class="font-bold text-gray-900">4.</span> –ö–æ–ø–∏—Ç–µ —à—Ç–∞–º–ø—ã –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –ø–æ–¥–∞—Ä–∫–∏!</li>
            </ul>
        </div>
    </div>

    <!-- === 7. ADMIN DASHBOARD (Updated for SaaS) === -->
    <div id="view-admin" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold text-gray-900">–í–ª–∞–¥–µ–ª–µ—Ü</h2>
            <div class="px-3 py-1 bg-gray-100 rounded-full text-xs font-bold text-gray-500">ADMIN</div>
        </div>

        <div class="bg-theme-soft border border-theme/20 rounded-2xl p-6 mb-6">
            <h3 class="text-theme-dark font-bold text-lg mb-1" id="admin-biz-name">...</h3>
            <p class="text-xs text-theme/80">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏–µ–º</p>
        </div>

        <div class="grid gap-4">
            <button onclick="AdminManager.scan()" class="w-full py-5 bg-gray-900 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-3">
                <i data-lucide="scan-line" class="w-6 h-6"></i>
                –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ö–ª–∏–µ–Ω—Ç–∞
            </button>

            <!-- Settings Button -->
            <button onclick="Router.go('admin-settings')" class="w-full py-5 bg-white border border-gray-200 text-gray-800 font-bold rounded-2xl shadow-sm active:scale-95 transition-transform flex items-center justify-center gap-3">
                <i data-lucide="settings" class="w-6 h-6 text-gray-400"></i>
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –î–∏–∑–∞–π–Ω–∞
            </button>
        </div>
        <div id="scan-status" class="mt-6 text-center h-6 text-sm font-medium"></div>
    </div>

    <!-- 8. ADMIN SETTINGS (NEW SaaS Feature) -->
    <div id="view-admin-settings" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center mb-6">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900 active:scale-90 transition-transform"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        </div>

        <div class="space-y-6 flex-1 overflow-y-auto pb-10">
            <!-- Name Input -->
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–≤–µ–¥–µ–Ω–∏—è</label>
                <input type="text" id="setting-name" class="w-full p-4 bg-white border border-gray-200 rounded-xl focus:border-theme focus:ring-1 focus:ring-theme outline-none transition-all font-medium">
            </div>

            <!-- Color Picker -->
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">–§–∏—Ä–º–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç</label>
                <div class="flex items-center gap-4 bg-white p-2 rounded-xl border border-gray-200">
                    <input type="color" id="setting-color" class="w-12 h-12 rounded-lg cursor-pointer border-none bg-transparent" value="#F59E0B">
                    <span class="text-gray-500 font-mono text-sm" id="setting-color-hex">#F59E0B</span>
                </div>
            </div>

            <!-- Target Stamps -->
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">–¶–µ–ª—å (—à—Ç–∞–º–ø–æ–≤)</label>
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="AdminManager.setTarget(6)" class="setting-target-btn p-3 rounded-xl border-2 border-gray-100 font-bold text-gray-400" data-val="6">6</button>
                    <button onclick="AdminManager.setTarget(8)" class="setting-target-btn p-3 rounded-xl border-2 border-gray-100 font-bold text-gray-400" data-val="8">8</button>
                    <button onclick="AdminManager.setTarget(10)" class="setting-target-btn p-3 rounded-xl border-2 border-gray-100 font-bold text-gray-400" data-val="10">10</button>
                </div>
            </div>

            <!-- Logo URL -->
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">–°—Å—ã–ª–∫–∞ –Ω–∞ –ª–æ–≥–æ—Ç–∏–ø</label>
                <input type="url" id="setting-logo" placeholder="https://..." class="w-full p-4 bg-white border border-gray-200 rounded-xl focus:border-theme text-xs text-gray-500 outline-none">
            </div>
        </div>

        <button onclick="AdminManager.saveSettings()" class="w-full py-4 bg-gray-900 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </button>
    </div>

    <!-- === ADMIN CONFLICT MODAL (Restored from v2) === -->
    <div id="admin-conflict-modal" class="hidden fixed inset-0 z-[70] bg-black/50 flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-theme-soft text-theme rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-circle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900">–í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è</h3>
                <p class="text-sm text-gray-500 mt-2">–ö–ª–∏–µ–Ω—Ç: <span id="conflict-username" class="font-bold text-gray-900">...</span></p>
                <p class="text-gray-600 mt-2 bg-gray-50 p-2 rounded-lg text-sm">–£ –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å –±–æ–Ω—É—Å—ã (<span id="conflict-bonus-count" class="font-bold"></span> —à—Ç).<br>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?</p>
            </div>
            <div class="flex flex-col gap-3">
                <button onclick="AdminManager.resolve('EARN')" class="w-full py-3 bg-gray-100 text-gray-800 font-bold rounded-xl active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> –¢–æ–ª—å–∫–æ –Ω–∞–∫–æ–ø–∏—Ç—å
                </button>
                <button onclick="AdminManager.resolve('REDEEM')" class="w-full py-3 bg-theme text-white font-bold rounded-xl shadow-lg shadow-theme/20 active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <i data-lucide="gift" class="w-4 h-4"></i> –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å
                </button>
            </div>
            <button onclick="AdminManager.closeConflict()" class="mt-4 text-sm text-gray-400 w-full text-center hover:text-gray-600">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const API_BASE = 'https://n8n.inflio.xyz/webhook';
        const tg = window.Telegram.WebApp;

        // --- STATE ---
        const State = {
            user: null,
            config: { // Default Config (Fallback)
                name: "Loading...",
                target_count: 6,
                theme_color: "#F59E0B",
                reward_name: "–ë–æ–Ω—É—Å",
                logo_url: "",
                currency_symbol: "‚≠êÔ∏è"
            },
            balance: 0,
            bonusCups: 0,
            totalStamps: 0,
            rank: '–ù–æ–≤–∏—á–æ–∫',
            currentSessionId: null,
            qrIntent: 'EARN',
            tempTarget: 6 // For Settings UI
        };

        // --- ROUTER ---
        const Router = {
            history: [],
            go(viewId, param = null) {
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                const target = document.getElementById(`view-${viewId}`);
                if(target) {
                    target.classList.add('active');
                    this.history.push(viewId);
                    
                    if(viewId === 'qr') {
                        State.qrIntent = param || 'EARN'; 
                        QRManager.generate();
                        UIManager.updateQRView(); 
                    }
                    if(viewId === 'home') UIManager.renderHome();
                    if(viewId === 'card') UIManager.renderCard();
                    if(viewId === 'bonuses') UIManager.renderBonuses(); // Restored
                    if(viewId === 'admin-settings') AdminManager.initSettingsForm();
                }
                
                if(this.history.length > 1) tg.BackButton.show();
                else tg.BackButton.hide();
                setTimeout(() => lucide.createIcons(), 50);
            },
            back() {
                if(this.history.length <= 1) return;
                this.history.pop();
                const prev = this.history[this.history.length - 1];
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${prev}`).classList.add('active');
                if(prev !== 'qr') QRManager.stop();
                if(this.history.length <= 1) tg.BackButton.hide();
            }
        };

        // --- API LAYER ---
        const API = {
            async request(endpoint, method = 'GET', body = null) {
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Telegram-Auth': tg.initData || ''
                };
                let url = `${API_BASE}/${endpoint}`;
                const config = { method, headers };
                if (body && method !== 'GET') config.body = JSON.stringify(body);
                if (body && method === 'GET') url += `?${new URLSearchParams(body).toString()}`;

                try {
                    const res = await fetch(url, config);
                    if (!res.ok) throw new Error('API Error');
                    return await res.json();
                } catch (e) {
                    console.error("Net Error", e);
                    throw e;
                }
            },
            async initApp(startParam) {
                return await this.request('init-app', 'GET', { start_param: startParam });
            },
            async saveSettings(settings) {
                return await this.request('save-settings', 'POST', { settings });
            },
            async getQR(userId, intent) {
                 return await this.request('get-qr', 'GET', { intent }); // user_id is in token now
            },
            async checkStatus(sid) {
                 return await this.request('check-status', 'GET', { session_id: sid });
            },
            async scanQR(sid, action) {
                return await this.request('scan-qr', 'POST', { qr_session: sid, action });
            }
        };

        // --- UI MANAGER ---
        const UIManager = {
            // üé® THEME ENGINE
            applyTheme(cfg) {
                const root = document.documentElement;
                root.style.setProperty('--theme-color', cfg.theme_color);
                
                // Simple lighten logic for bg (optional: better to use HSL)
                root.style.setProperty('--theme-bg', cfg.bg_color || '#FFFBEB');
                
                // Set Content
                document.getElementById('app-title').innerText = cfg.name;
                document.getElementById('app-logo').src = cfg.logo_url || 'https://via.placeholder.com/100?text=Logo';
                document.getElementById('admin-biz-name').innerText = cfg.name;
                
                // Set Telegram Header
                tg.setHeaderColor(cfg.theme_color);
                tg.setBackgroundColor('#F9FAFB');
            },

            renderHome() {
                const { user, balance, config } = State;
                document.getElementById('user-name').innerText = user.first_name;
                document.getElementById('user-balance').innerText = balance;
                document.getElementById('target-count-display').innerText = config.target_count;
                
                const left = config.target_count - balance;
                document.getElementById('stamps-left').innerText = left > 0 ? left : "0";
                document.getElementById('reward-name-display').innerText = config.reward_name;

                // Rank Logic
                let rank = "–ì–æ—Å—Ç—å";
                if (State.totalStamps > 10) rank = "–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π";
                if (State.totalStamps > 30) rank = "VIP –ö–ª–∏–µ–Ω—Ç";
                document.getElementById('user-rank').innerText = rank;

                // Bonus Button
                const bonusTxt = document.getElementById('home-bonus-count');
                if (State.bonusCups > 0) {
                    bonusTxt.innerText = `${State.bonusCups} —à—Ç.`;
                    bonusTxt.classList.add('text-theme', 'font-bold');
                } else {
                    bonusTxt.innerText = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö";
                    bonusTxt.classList.remove('text-theme', 'font-bold');
                }
            },

            renderBonuses() { // Restored Logic
                document.getElementById('bonus-rank').innerText = State.rank;
                document.getElementById('bonus-cups-display').innerText = State.bonusCups;
                
                const btn = document.getElementById('btn-use-bonus');
                if (State.bonusCups > 0) {
                    btn.disabled = false;
                    btn.classList.remove('grayscale', 'opacity-50');
                    btn.innerHTML = '<i data-lucide="qr-code" class="w-5 h-5"></i> –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å';
                } else {
                    btn.disabled = true;
                    btn.classList.add('grayscale', 'opacity-50');
                    btn.innerText = "–ù–µ—Ç –±–æ–Ω—É—Å–æ–≤";
                }
            },

            renderCard() {
                const grid = document.getElementById('stamps-container');
                grid.innerHTML = '';
                const total = State.config.target_count;
                const current = State.balance;
                const symbol = State.config.currency_symbol || '‚≠êÔ∏è';

                for (let i = 1; i <= total; i++) {
                    const active = i <= current;
                    const el = document.createElement('div');
                    el.className = `w-16 h-16 rounded-full flex items-center justify-center text-xl font-bold border-4 transition-all duration-300 ${active ? 'bg-theme-soft border-theme text-theme scale-105 shadow-md' : 'bg-gray-50 border-gray-100 text-gray-300'}`;
                    
                    if (active) el.innerHTML = symbol;
                    else el.innerText = i;
                    grid.appendChild(el);
                }
            },

            updateQRView() {
                const isRedeem = State.qrIntent === 'REDEEM';
                const t = document.getElementById('qr-view-title');
                const h = document.getElementById('qr-view-hint');
                const bar = document.getElementById('timer-bar');

                if(isRedeem) {
                    t.innerText = "–°–ø–∏—Å–∞–Ω–∏–µ –±–æ–Ω—É—Å–∞";
                    h.innerText = `–ü–æ–∫–∞–∂–∏—Ç–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è: ${State.config.reward_name}`;
                    h.className = "mb-6 px-4 py-2 bg-theme/20 text-theme-dark rounded-lg text-sm font-bold border border-theme/30";
                    bar.style.backgroundColor = "var(--theme-color)";
                } else {
                    t.innerText = "–ö–æ–ø–∏–º –±–∞–ª–ª—ã";
                    h.innerText = `–î–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è ${State.config.currency_symbol}`;
                    h.className = "mb-6 px-4 py-2 bg-white/10 text-white rounded-lg text-sm font-medium";
                    bar.style.backgroundColor = "var(--theme-color)";
                }
            }
        };

        // --- QR LOGIC ---
        const QRManager = {
            timer: null, poll: null,
            async generate() {
                document.getElementById('qrcode').innerHTML = '';
                try {
                    const data = await API.getQR(State.user.id, State.qrIntent);
                    const ses = Array.isArray(data) ? data[0] : data;
                    State.sessId = ses.session_id;

                    new QRCode(document.getElementById("qrcode"), {
                        text: JSON.stringify({ sid: ses.session_id }),
                        width: 200, height: 200,
                        colorDark: "#111827", colorLight: "#ffffff"
                    });
                    this.startPoll();
                } catch(e) { alert("Error generating QR"); }
            },
            startPoll() {
                if(this.poll) clearInterval(this.poll);
                this.poll = setInterval(async () => {
                    try {
                        const res = await API.checkStatus(State.sessId);
                        const s = Array.isArray(res) ? res[0] : res;
                        if(s.status === 'USED') {
                            this.stop();
                            State.balance = s.balance;
                            State.bonusCups = s.bonus_cups;
                            State.totalStamps = (State.totalStamps || 0) + 1;
                            
                            tg.HapticFeedback.notificationOccurred('success');
                            document.getElementById('success-title').innerText = State.qrIntent === 'REDEEM' ? '–°–ø–∏—Å–∞–Ω–æ!' : '–ù–∞—á–∏—Å–ª–µ–Ω–æ!';
                            document.getElementById('success-message').innerText = `–ë–∞–ª–∞–Ω—Å: ${s.balance}/${State.config.target_count}`;
                            Router.go('success');
                        }
                    } catch(e) {}
                }, 2000);
            },
            stop() { clearInterval(this.poll); clearInterval(this.timer); }
        };

        // --- ADMIN MANAGER (Merged v2 + SaaS) ---
        const AdminManager = {
            conflictSessionId: null,

            initSettingsForm() {
                const cfg = State.config;
                document.getElementById('setting-name').value = cfg.name;
                document.getElementById('setting-color').value = cfg.theme_color;
                document.getElementById('setting-color-hex').innerText = cfg.theme_color;
                document.getElementById('setting-logo').value = cfg.logo_url;
                this.setTarget(cfg.target_count); 

                document.getElementById('setting-color').addEventListener('input', (e) => {
                    document.getElementById('setting-color-hex').innerText = e.target.value;
                });
            },

            setTarget(val) {
                State.tempTarget = val;
                document.querySelectorAll('.setting-target-btn').forEach(btn => {
                    if(parseInt(btn.dataset.val) === val) {
                        btn.classList.add('border-theme', 'text-theme', 'bg-theme-soft');
                        btn.classList.remove('border-gray-100', 'text-gray-400');
                    } else {
                        btn.classList.remove('border-theme', 'text-theme', 'bg-theme-soft');
                        btn.classList.add('border-gray-100', 'text-gray-400');
                    }
                });
            },

            async saveSettings() {
                const newSettings = {
                    name: document.getElementById('setting-name').value,
                    config: {
                        theme_color: document.getElementById('setting-color').value,
                        target_count: State.tempTarget,
                        logo_url: document.getElementById('setting-logo').value
                    }
                };
                try {
                    tg.MainButton.showProgress();
                    await API.saveSettings(newSettings);
                    State.config = { ...State.config, ...newSettings.config, name: newSettings.name };
                    UIManager.applyTheme(State.config);
                    tg.MainButton.hideProgress();
                    tg.HapticFeedback.notificationOccurred('success');
                    alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
                    Router.back();
                } catch(e) { tg.MainButton.hideProgress(); alert("–û—à–∏–±–∫–∞"); }
            },

            scan() {
                tg.showScanQrPopup({ text: "–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞" }, async (txt) => {
                    tg.closeScanQrPopup();
                    try {
                        const sid = JSON.parse(txt).sid;
                        const res = await API.scanQR(sid);
                        const r = Array.isArray(res) ? res[0].result : res.result;
                        
                        if(r.status === 'success') {
                            tg.showAlert(r.message);
                            document.getElementById('scan-status').innerHTML = `<span class="text-green-600">‚úÖ ${r.message}</span>`;
                        } else if (r.status === 'confirmation_required') {
                            // [RESTORED] Conflict Logic
                            this.conflictSessionId = r.session_id;
                            document.getElementById('conflict-username').innerText = r.user_name || '–ö–ª–∏–µ–Ω—Ç';
                            document.getElementById('conflict-bonus-count').innerText = r.bonus_cups;
                            document.getElementById('admin-conflict-modal').classList.remove('hidden');
                        } else {
                            tg.showAlert(r.message);
                        }
                    } catch(e) { alert("Invalid QR"); }
                    return true;
                });
            },

            async resolve(action) {
                this.closeConflict();
                try {
                    const res = await API.scanQR(this.conflictSessionId, action);
                    const r = Array.isArray(res) ? res[0].result : res.result;
                    if (r.status === 'success') tg.showAlert(r.message);
                    else tg.showAlert(r.message);
                } catch (e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
            },

            closeConflict() {
                document.getElementById('admin-conflict-modal').classList.add('hidden');
                this.conflictSessionId = null;
            }
        };

        // --- BOOTSTRAP ---
        async function bootstrap() {
            tg.expand();
            tg.BackButton.onClick(() => Router.back());

            const user = tg.initDataUnsafe?.user;
            const startParam = tg.initDataUnsafe?.start_param || "";

            if (!user) {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('stub-view').classList.remove('hidden');
                return;
            }

            try {
                // SaaS Init
                const res = await API.initApp(startParam);
                const data = Array.isArray(res) ? res[0] : res;
                
                State.user = user;
                State.config = data.business_config || State.config; // Load from DB
                State.balance = data.balance;
                State.bonusCups = data.bonus_cups;
                State.totalStamps = data.total_stamps;

                UIManager.applyTheme(State.config);
                
                document.getElementById('loader').classList.add('hidden');

                if (data.is_admin) Router.go('admin');
                else Router.go('home');

            } catch (e) {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('view-error').classList.remove('hidden');
            }
        }

        bootstrap();
    </script>
</body>
</html>
