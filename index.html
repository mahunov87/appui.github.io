<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loyalty Hybrid</title>
    
    <!-- Dependencies -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- DYNAMIC THEME ENGINE --- */
        :root {
            --theme-color: #2563EB;
            --theme-bg: #EFF6FF;
            --theme-text: #1E40AF;
        }

        /* Classes generated for dynamic usage */
        .bg-theme { background-color: var(--theme-color) !important; }
        .bg-theme-soft { background-color: var(--theme-bg) !important; }
        .text-theme { color: var(--theme-color) !important; }
        .text-theme-dark { color: var(--theme-text) !important; }
        .border-theme { border-color: var(--theme-color) !important; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #F9FAFB;
            /* Anti-FOUC: –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–æ –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ JS */
            visibility: hidden; 
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* --- UI COMPONENTS --- */
        .page {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            background: #F9FAFB;
            display: none;
            flex-direction: column;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .page.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
            z-index: 10;
        }

        /* Success Animation */
        .stamp-enter { animation: stamp-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes stamp-pop {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Custom Scrollbar hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-gray-900 h-screen overflow-hidden">

    <!-- === LOADER === -->
    <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
        <div class="w-10 h-10 border-4 border-gray-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-400 text-sm font-medium animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>

    <!-- === DESKTOP STUB === -->
    <div id="stub-view" class="hidden fixed inset-0 z-[60] bg-gray-50 flex flex-col items-center justify-center p-6 text-center">
        <i data-lucide="smartphone" class="w-16 h-16 text-gray-300 mb-4"></i>
        <h2 class="text-xl font-bold mb-2">–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</h2>
        <p class="text-gray-500">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Telegram Mobile.</p>
    </div>

    <!-- === GLOBAL ERROR === -->
    <div id="view-error" class="hidden fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-8 text-center">
        <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-4">
            <i data-lucide="wifi-off" class="w-8 h-8"></i>
        </div>
        <h2 class="text-xl font-bold mb-2">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏</h2>
        <p class="text-gray-500 mb-6">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</p>
        <button onclick="window.location.reload()" class="px-6 py-3 bg-gray-900 text-white rounded-xl font-bold">
            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
        </button>
    </div>

    <!-- ================= VIEWS ================= -->

    <!-- [NEW] 0. DASHBOARD (HYBRID HUB) -->
    <!-- –≠—Ç–æ—Ç —ç–∫—Ä–∞–Ω –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–π Wallet View –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="view-dashboard" class="page px-5 py-6">
        <header class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-2xl font-black text-gray-900">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h1>
                <p class="text-sm text-gray-500" id="dash-username">–ü—Ä–∏–≤–µ—Ç!</p>
            </div>
            <div id="dashboard-avatar" class="w-10 h-10 bg-gray-200 rounded-full overflow-hidden"></div>
        </header>

        <!-- Admin Section -->
        <div id="dash-admin-section" class="mb-8 hidden">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 pl-1">–ú–æ–π –ë–∏–∑–Ω–µ—Å</p>
            <div id="dash-admin-list" class="space-y-3">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Wallet Section -->
        <div id="dash-wallet-section" class="flex-1">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 pl-1">–ú–æ–∏ –ö–∞—Ä—Ç—ã</p>
            <div id="dash-wallet-list" class="space-y-3">
                <!-- Injected via JS -->
            </div>
            
            <div id="dash-wallet-empty" class="hidden py-12 text-center bg-gray-50 rounded-2xl border border-dashed border-gray-200">
                <i data-lucide="wallet" class="w-10 h-10 text-gray-300 mx-auto mb-3"></i>
                <h3 class="text-gray-900 font-bold mb-1">–ö–æ—à–µ–ª–µ–∫ –ø—É—Å—Ç</h3>
                <p class="text-gray-400 text-xs px-6">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ –∑–∞–≤–µ–¥–µ–Ω–∏–∏, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é –∫–∞—Ä—Ç—É.</p>
            </div>
        </div>
    </div>

    <!-- 1. BUSINESS HOME (CUSTOMER VIEW) -->
    <div id="view-home" class="page px-5 py-6">
        <header class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –≤–µ–¥–µ—Ç –Ω–∞ –î–∞—à–±–æ—Ä–¥, –µ—Å–ª–∏ –∫–∞—Ä—Ç > 1 –∏–ª–∏ –µ—Å–ª–∏ –º—ã –∞–¥–º–∏–Ω -->
                <button onclick="Router.go('dashboard')" class="p-1 -ml-1 text-gray-400 active:scale-90 transition-transform">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                <img id="app-logo" src="" class="w-10 h-10 rounded-full object-cover border border-gray-100 bg-white shadow-sm">
                <div>
                    <h1 id="app-title" class="text-lg font-bold text-gray-900 leading-tight">...</h1>
                    <p class="text-xs text-gray-500" id="app-subtitle">–ë–æ–Ω—É—Å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</p>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü –≠–¢–û–ì–û –±–∏–∑–Ω–µ—Å–∞) -->
            <button id="btn-context-admin" onclick="Router.go('admin')" class="hidden w-10 h-10 bg-gray-900 text-white rounded-full flex items-center justify-center shadow-md active:scale-90 transition-transform">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </header>

        <!-- Stats Card -->
        <div class="bg-gray-900 rounded-3xl p-6 text-white shadow-xl shadow-gray-200 mb-6 relative overflow-hidden group">
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-theme opacity-20 rounded-full blur-3xl group-hover:opacity-30 transition-opacity"></div>
            <div class="relative z-10 flex justify-between items-end">
                <div>
                    <p class="text-gray-400 text-xs font-bold uppercase mb-1">–ë–∞–ª–∞–Ω—Å</p>
                    <div class="flex items-baseline gap-1">
                        <span id="user-balance" class="text-4xl font-bold">0</span>
                        <span class="text-gray-500 text-xl">/<span id="target-count">6</span></span>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-400 mb-1">–î–æ –±–æ–Ω—É—Å–∞</p>
                    <p id="stamps-left" class="text-xl font-bold text-theme">6</p>
                </div>
            </div>
        </div>

        <!-- Bonuses Button -->
        <button onclick="Router.go('bonuses')" class="w-full mb-6 py-4 bg-theme-soft border border-theme/20 rounded-2xl flex items-center justify-between px-6 shadow-sm active:scale-95 transition-transform group">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-theme text-white rounded-full flex items-center justify-center shadow-lg shadow-theme/30">
                    <i data-lucide="gift" class="w-5 h-5"></i>
                </div>
                <div class="text-left">
                    <p class="font-bold text-gray-800">–ú–æ–∏ –±–æ–Ω—É—Å—ã</p>
                    <p class="text-xs text-theme-dark font-medium" id="home-bonus-count">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö</p>
                </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
        </button>

        <!-- Grid Actions -->
        <div class="grid grid-cols-2 gap-4">
            <button onclick="Router.go('card')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center gap-2 active:scale-95 transition-transform">
                <i data-lucide="credit-card" class="w-6 h-6 text-blue-500"></i>
                <span class="font-bold text-sm">–ö–∞—Ä—Ç–∞</span>
            </button>
            <button onclick="Router.go('qr', 'EARN')" class="bg-theme p-4 rounded-2xl shadow-lg shadow-theme/30 flex flex-col items-center gap-2 active:scale-95 transition-transform text-white">
                <i data-lucide="qr-code" class="w-6 h-6"></i>
                <span class="font-bold text-sm">QR –ö–æ–¥</span>
            </button>
            <button onclick="Router.go('contacts')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center gap-2 active:scale-95 transition-transform">
                <i data-lucide="map-pin" class="w-6 h-6 text-green-500"></i>
                <span class="font-bold text-sm">–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
            </button>
            <button onclick="Router.go('help')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center gap-2 active:scale-95 transition-transform">
                <i data-lucide="help-circle" class="w-6 h-6 text-purple-500"></i>
                <span class="font-bold text-sm">–ü–æ–º–æ—â—å</span>
            </button>
        </div>
    </div>

    <!-- 2. BONUS VIEW -->
    <div id="view-bonuses" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center mb-6">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ù–∞–≥—Ä–∞–¥—ã</h2>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center">
            <div class="w-24 h-24 bg-theme-soft rounded-full flex items-center justify-center mb-6 text-theme">
                <i data-lucide="gift" class="w-12 h-12"></i>
            </div>
            <h3 class="text-2xl font-black text-gray-900 mb-2" id="bonus-cups-big">0</h3>
            <p class="text-gray-500 mb-8 text-center">–î–æ—Å—Ç—É–ø–Ω—ã—Ö –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –Ω–∞–ø–∏—Ç–∫–æ–≤</p>
            <button id="btn-redeem" onclick="Router.go('qr', 'REDEEM')" class="w-full py-4 bg-theme text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform disabled:opacity-50 disabled:grayscale">
                –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å
            </button>
        </div>
    </div>

    <!-- 3. CARD VIEW -->
    <div id="view-card" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center mb-6">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ú–æ—è –∫–∞—Ä—Ç–∞</h2>
        </div>
        <div class="bg-white rounded-3xl p-6 shadow-lg border border-gray-100 flex-1 flex flex-col items-center">
            <div id="stamps-grid" class="grid grid-cols-3 gap-4 w-full place-items-center mb-auto pt-8">
                <!-- Generated -->
            </div>
            <button onclick="Router.go('qr', 'EARN')" class="w-full py-4 mt-8 bg-gray-900 text-white font-bold rounded-xl active:scale-95">
                –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
    </div>

    <!-- 4. QR VIEW -->
    <div id="view-qr" class="page px-6 py-6 flex flex-col bg-gray-900 text-white">
        <div class="flex items-center mb-6">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2" id="qr-title">QR –ö–æ–¥</h2>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center">
            <div id="qr-hint" class="mb-6 px-4 py-2 bg-white/10 rounded-lg text-sm text-center">...</div>
            <div class="bg-white p-5 rounded-3xl shadow-2xl mb-8 relative">
                <div id="qrcode"></div>
                <div id="qr-loader" class="absolute inset-0 bg-white flex items-center justify-center rounded-3xl">
                    <div class="w-8 h-8 border-4 border-gray-100 border-t-gray-800 rounded-full animate-spin"></div>
                </div>
            </div>
            <div class="w-full max-w-[200px] h-1 bg-gray-800 rounded-full overflow-hidden">
                <div id="timer-bar" class="h-full bg-theme transition-all duration-1000 ease-linear" style="width: 100%"></div>
            </div>
        </div>
    </div>

    <!-- 5. SUCCESS VIEW -->
    <div id="view-success" class="page px-6 py-6 flex flex-col items-center justify-center bg-theme-soft">
        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-6 shadow-lg shadow-theme/20 stamp-enter text-theme">
            <i data-lucide="check" class="w-12 h-12"></i>
        </div>
        <h2 id="success-title" class="text-2xl font-black text-gray-900 mb-2">–û—Ç–ª–∏—á–Ω–æ!</h2>
        <p id="success-message" class="text-gray-600 text-center mb-12">–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</p>
        <button onclick="Router.go('home')" class="w-full py-4 bg-white text-gray-900 font-bold rounded-xl shadow-sm active:scale-95 transition-transform">
            –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        </button>
    </div>

    <!-- 6. CONTACTS VIEW -->
    <div id="view-contacts" class="page px-6 py-6">
        <div class="flex items-center mb-6">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
        </div>
        <div class="space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-10 h-10 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                <div><p class="text-sm text-gray-400">–ê–¥—Ä–µ—Å</p><p class="font-bold">–£—Ç–æ—á–Ω—è–π—Ç–µ —É –±–∞—Ä–∏—Å—Ç–∞</p></div>
            </div>
            <a href="https://t.me/support" class="block bg-theme text-white p-4 rounded-xl text-center font-bold mt-8 shadow-lg shadow-theme/30">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</a>
        </div>
    </div>

    <!-- 7. HELP VIEW -->
    <div id="view-help" class="page px-6 py-6">
        <div class="flex items-center mb-6">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</h2>
        </div>
        <div class="prose text-gray-600">
            <ul class="space-y-4">
                <li class="flex gap-3"><span class="font-bold text-gray-900">1.</span> –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∫ –Ω–∞–º –∑–∞ –∫–æ—Ñ–µ.</li>
                <li class="flex gap-3"><span class="font-bold text-gray-900">2.</span> –ù–∞–∂–º–∏—Ç–µ "QR –ö–æ–¥" –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.</li>
                <li class="flex gap-3"><span class="font-bold text-gray-900">3.</span> –ü–æ–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –±–∞—Ä–∏—Å—Ç–∞.</li>
                <li class="flex gap-3"><span class="font-bold text-gray-900">4.</span> –ü–æ–ª—É—á–∏—Ç–µ —à—Ç–∞–º–ø. 6-–π –∫–æ—Ñ–µ ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ!</li>
            </ul>
        </div>
    </div>

    <!-- 8. ADMIN PANEL -->
    <div id="view-admin" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-2">
                <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h2 class="text-2xl font-bold text-gray-900">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            </div>
            <span class="px-2 py-1 bg-gray-100 text-xs font-bold rounded text-gray-500">ADMIN</span>
        </div>
        
        <div class="space-y-4">
            <button onclick="AdminManager.scan()" class="w-full py-6 bg-gray-900 text-white font-bold rounded-2xl shadow-lg flex flex-col items-center gap-2 active:scale-95">
                <i data-lucide="scan-line" class="w-8 h-8"></i>
                <span>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR –∫–ª–∏–µ–Ω—Ç–∞</span>
            </button>
            
            <button onclick="AdminManager.showInvite()" class="w-full py-4 bg-white border border-gray-200 text-gray-800 font-bold rounded-2xl flex items-center justify-center gap-3 active:scale-95">
                <i data-lucide="qr-code" class="w-5 h-5"></i>
                QR –¥–ª—è –≤—Ö–æ–¥–∞
            </button>

            <button onclick="Router.go('admin-settings')" class="w-full py-4 bg-white border border-gray-200 text-gray-800 font-bold rounded-2xl flex items-center justify-center gap-3 active:scale-95">
                <i data-lucide="sliders" class="w-5 h-5"></i>
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </div>
    </div>

    <!-- 9. ADMIN SETTINGS -->
    <div id="view-admin-settings" class="page px-6 py-6">
        <div class="flex items-center mb-6">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        </div>
        <div class="space-y-5">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input id="set-name" type="text" class="w-full p-4 bg-white border border-gray-200 rounded-xl outline-none focus:border-blue-500 transition-colors">
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">–¶–≤–µ—Ç —Ç–µ–º—ã</label>
                <div class="flex gap-4 items-center bg-white p-2 rounded-xl border border-gray-200">
                    <input id="set-color" type="color" class="w-10 h-10 rounded border-none bg-transparent">
                    <span id="set-color-val" class="font-mono text-sm text-gray-500">#000000</span>
                </div>
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">–¶–µ–ª—å (—à—Ç–∞–º–ø–æ–≤)</label>
                <div class="flex gap-2">
                    <button onclick="AdminManager.selectTarget(6)" class="flex-1 p-3 border rounded-xl font-bold target-btn" data-val="6">6</button>
                    <button onclick="AdminManager.selectTarget(8)" class="flex-1 p-3 border rounded-xl font-bold target-btn" data-val="8">8</button>
                    <button onclick="AdminManager.selectTarget(10)" class="flex-1 p-3 border rounded-xl font-bold target-btn" data-val="10">10</button>
                </div>
            </div>
            <button onclick="AdminManager.save()" class="w-full py-4 bg-blue-600 text-white font-bold rounded-xl mt-4 active:scale-95">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- === MODALS === -->
    
    <!-- Invite Modal -->
    <div id="modal-invite" class="hidden fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-6 fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center relative">
            <button onclick="document.getElementById('modal-invite').classList.add('hidden')" class="absolute top-4 right-4 p-2 text-gray-400"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h3 class="text-lg font-bold mb-4">–ö–æ–¥ –∑–∞–≤–µ–¥–µ–Ω–∏—è</h3>
            <div id="invite-qr" class="flex justify-center mb-4"></div>
            <p class="text-xs text-gray-400 font-mono break-all bg-gray-50 p-2 rounded" id="invite-link">...</p>
        </div>
    </div>

    <!-- Conflict Modal -->
    <div id="modal-conflict" class="hidden fixed inset-0 z-[70] bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-2">–ï—Å—Ç—å –±–æ–Ω—É—Å—ã!</h3>
            <p class="text-sm text-gray-500 mb-4">–ö–ª–∏–µ–Ω—Ç –Ω–∞–∫–æ–ø–∏–ª –Ω–∞ –ø–æ–¥–∞—Ä–æ–∫. –°–ø–∏—Å–∞—Ç—å –µ–≥–æ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å —à—Ç–∞–º–ø?</p>
            <div class="flex flex-col gap-3">
                <button onclick="AdminManager.resolve('EARN')" class="py-3 bg-gray-100 font-bold rounded-xl">–¢–æ–ª—å–∫–æ —à—Ç–∞–º–ø</button>
                <button onclick="AdminManager.resolve('REDEEM')" class="py-3 bg-blue-600 text-white font-bold rounded-xl">–°–ø–∏—Å–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const API_BASE = 'https://n8n.inflio.xyz/webhook'; // Update if needed
        const BOT_USERNAME = 'SeldonLoya_bot'; 
        const tg = window.Telegram.WebApp;

        // --- GLOBAL STATE ---
        const State = {
            user: null,
            owned: [],  // Businesses I own
            member: [], // Businesses I use
            activeBusiness: null, // Current context
            
            // Temporary Logic
            qrSession: null,
            tempTarget: 6
        };

        // --- ROUTER ---
        const Router = {
            history: [],
            
            go(viewId, param = null) {
                const views = document.querySelectorAll('.page');
                views.forEach(v => v.classList.remove('active'));
                
                const target = document.getElementById(`view-${viewId}`);
                if(target) {
                    target.classList.add('active');
                    this.history.push(viewId);
                    
                    // View Hooks
                    if(viewId === 'home') UIManager.renderHome();
                    if(viewId === 'dashboard') UIManager.renderDashboard();
                    if(viewId === 'card') UIManager.renderCard();
                    if(viewId === 'bonuses') UIManager.renderBonuses();
                    if(viewId === 'success') UIManager.renderSuccess(); // Hook for success
                    if(viewId === 'qr') QRManager.init(param);
                    if(viewId === 'admin-settings') AdminManager.initSettings();
                }

                // Show back button logic
                if(this.history.length > 1) tg.BackButton.show();
                else tg.BackButton.hide();
                
                setTimeout(() => lucide.createIcons(), 50);
            },

            back() {
                if(this.history.length <= 1) return;
                this.history.pop();
                const prev = this.history[this.history.length - 1];
                
                document.querySelectorAll('.page').forEach(v => v.classList.remove('active'));
                document.getElementById(`view-${prev}`).classList.add('active');
                
                if(prev !== 'qr') QRManager.stop();
                if(this.history.length <= 1) tg.BackButton.hide();
            }
        };

        // --- API LAYER ---
        const API = {
            async call(endpoint, body = {}) {
                try {
                    const headers = { 
                        'Content-Type': 'application/json',
                        'X-Telegram-Auth': tg.initData 
                    };
                    
                    // GET requests helper for init
                    let url = `${API_BASE}/${endpoint}`;
                    let opts = { method: 'POST', headers, body: JSON.stringify(body) };
                    
                    if(endpoint === 'init-app') {
                        opts = { method: 'GET', headers };
                        const params = new URLSearchParams(body).toString();
                        url += `?${params}`;
                    } else if (endpoint === 'check-status' || endpoint === 'get-qr') {
                        opts = { method: 'GET', headers };
                        const params = new URLSearchParams(body).toString();
                        url += `?${params}`;
                    }

                    const res = await fetch(url, opts);
                    if(!res.ok) throw new Error('Network error');
                    return await res.json();
                } catch(e) {
                    console.error(e);
                    throw e;
                }
            }
        };

        // --- UI MANAGER ---
        const UIManager = {
            applyTheme(config) {
                const r = document.documentElement.style;
                r.setProperty('--theme-color', config.theme_color || '#2563EB');
                r.setProperty('--theme-bg', config.bg_color || '#EFF6FF');
                
                tg.setHeaderColor(config.theme_color || '#ffffff');
                tg.setBackgroundColor('#F9FAFB');
            },

            renderDashboard() {
                // User info
                if (State.user) {
                    document.getElementById('dash-username').innerText = `–ü—Ä–∏–≤–µ—Ç, ${State.user.first_name}!`;
                    if(State.user.photo_url) {
                        document.getElementById('dashboard-avatar').innerHTML = `<img src="${State.user.photo_url}" class="w-full h-full object-cover">`;
                    }
                }

                // Admin Section
                const adminList = document.getElementById('dash-admin-list');
                const adminSec = document.getElementById('dash-admin-section');
                adminList.innerHTML = '';
                
                // Show Admin section if I own anything
                if(State.owned && State.owned.length > 0) {
                    adminSec.classList.remove('hidden');
                    State.owned.forEach(biz => {
                        const div = document.createElement('div');
                        div.className = "bg-gray-900 text-white p-4 rounded-2xl flex items-center justify-between shadow-lg active:scale-95 transition-transform cursor-pointer";
                        div.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center"><i data-lucide="briefcase" class="w-5 h-5"></i></div>
                                <span class="font-bold">${biz.name}</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-500"></i>
                        `;
                        div.onclick = () => {
                            State.activeBusiness = { ...biz, role: 'admin' }; 
                            // Ensure config is flat
                            State.activeBusiness.theme_color = biz.config.theme_color;
                            State.activeBusiness.target_count = biz.config.target_count;
                            State.activeBusiness.logo_url = biz.config.logo_url;
                            
                            this.applyTheme(State.activeBusiness);
                            Router.go('admin');
                        };
                        adminList.appendChild(div);
                    });
                } else {
                    adminSec.classList.add('hidden');
                }

                // Wallet Section
                const walletList = document.getElementById('dash-wallet-list');
                walletList.innerHTML = '';
                
                if(State.member && State.member.length > 0) {
                    document.getElementById('dash-wallet-empty').classList.add('hidden');
                    State.member.forEach(w => {
                        const div = document.createElement('div');
                        div.className = "bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex items-center justify-between active:scale-95 transition-transform cursor-pointer";
                        div.innerHTML = `
                            <div class="flex items-center gap-3">
                                <img src="${w.logo || ''}" class="w-10 h-10 rounded-full bg-gray-50 object-cover border border-gray-100">
                                <div>
                                    <p class="font-bold text-gray-900">${w.name}</p>
                                    <p class="text-xs text-gray-500">${w.balance}/${w.target} —à—Ç–∞–º–ø–æ–≤</p>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300"></i>
                        `;
                        div.onclick = () => {
                            State.activeBusiness = { 
                                id: w.business_id, 
                                name: w.name, 
                                role: 'customer',
                                config: { theme_color: w.theme, target_count: w.target, logo_url: w.logo },
                                // Mapped for easier access
                                theme_color: w.theme,
                                target_count: w.target,
                                logo_url: w.logo,
                                balance: w.balance,
                                bonus_cups: w.bonus_cups
                            };
                            this.applyTheme(State.activeBusiness);
                            Router.go('home');
                        };
                        walletList.appendChild(div);
                    });
                } else {
                    document.getElementById('dash-wallet-empty').classList.remove('hidden');
                }
            },

            renderHome() {
                const b = State.activeBusiness;
                document.getElementById('app-title').innerText = b.name;
                document.getElementById('app-logo').src = b.logo_url || '';
                document.getElementById('user-balance').innerText = b.balance;
                document.getElementById('target-count').innerText = b.target_count;
                
                const left = Math.max(0, b.target_count - b.balance);
                document.getElementById('stamps-left').innerText = left;

                const bonusTxt = document.getElementById('home-bonus-count');
                if(b.bonus_cups > 0) {
                    bonusTxt.innerText = `${b.bonus_cups} –¥–æ—Å—Ç—É–ø–Ω–æ`;
                    bonusTxt.classList.add('text-theme');
                } else {
                    bonusTxt.innerText = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö";
                    bonusTxt.classList.remove('text-theme');
                }
                
                // Context Admin Button: Check if I own THIS business
                const isOwner = State.owned.some(o => o.id === b.id);
                const adminBtn = document.getElementById('btn-context-admin');
                if(isOwner) {
                    adminBtn.classList.remove('hidden');
                    // Update click to switch context to admin mode for this business
                    adminBtn.onclick = () => {
                        const ownedRef = State.owned.find(o => o.id === b.id);
                        State.activeBusiness = { ...ownedRef, role: 'admin', theme_color: ownedRef.config.theme_color };
                        Router.go('admin');
                    }
                } else {
                    adminBtn.classList.add('hidden');
                }
            },

            renderCard() {
                const grid = document.getElementById('stamps-grid');
                grid.innerHTML = '';
                const b = State.activeBusiness;
                
                for(let i=1; i<=b.target_count; i++) {
                    const active = i <= b.balance;
                    const el = document.createElement('div');
                    el.className = `w-14 h-14 rounded-full flex items-center justify-center font-bold text-lg border-2 transition-all ${active ? 'bg-theme text-white border-theme scale-105 shadow-md' : 'bg-gray-50 border-gray-100 text-gray-300'}`;
                    el.innerHTML = active ? '<i data-lucide="coffee" class="w-6 h-6"></i>' : i;
                    grid.appendChild(el);
                }
                lucide.createIcons();
            },

            renderBonuses() {
                document.getElementById('bonus-cups-big').innerText = State.activeBusiness.bonus_cups;
                document.getElementById('btn-redeem').disabled = State.activeBusiness.bonus_cups <= 0;
            },

            renderSuccess() {
                const isRedeem = State.qrSession?.intent === 'REDEEM';
                const b = State.activeBusiness;
                const title = document.getElementById('success-title');
                const msg = document.getElementById('success-message');

                if (isRedeem) {
                    title.innerText = "–ë–æ–Ω—É—Å —Å–ø–∏—Å–∞–Ω!";
                    msg.innerText = "–ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –≤–∞—à–∏–º –∫–æ—Ñ–µ ‚òïÔ∏è";
                } else {
                    // Earn logic
                    if (b.balance === 0 && b.bonus_cups > 0) {
                        title.innerText = "üéâ –ü–æ–¥–∞—Ä–æ–∫!";
                        msg.innerText = "–í—ã –Ω–∞–∫–æ–ø–∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —à—Ç–∞–º–ø–æ–≤!";
                    } else {
                        title.innerText = "–®—Ç–∞–º–ø –ø–æ–ª—É—á–µ–Ω!";
                        msg.innerText = `–í–∞—à –±–∞–ª–∞–Ω—Å: ${b.balance} –∏–∑ ${b.target_count}`;
                    }
                }
            }
        };

        // --- QR MANAGER ---
        const QRManager = {
            interval: null,
            
            async init(intent) {
                const b = State.activeBusiness;
                State.qrSession = { intent }; // Store for success view
                document.getElementById('qr-loader').classList.remove('hidden');
                document.getElementById('qr-hint').innerText = intent === 'REDEEM' ? '–°–ø–∏—Å–∞–Ω–∏–µ –±–æ–Ω—É—Å–∞' : '–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —à—Ç–∞–º–ø–∞';
                
                try {
                    const res = await API.call('get-qr', { intent, business_id: b.id });
                    const session = Array.isArray(res) ? res[0] : res;
                    
                    document.getElementById('qrcode').innerHTML = '';
                    new QRCode(document.getElementById("qrcode"), {
                        text: JSON.stringify({ sid: session.session_id }),
                        width: 200, height: 200, colorDark: "#000000", colorLight: "#ffffff"
                    });
                    
                    document.getElementById('qr-loader').classList.add('hidden');
                    this.poll(session.session_id, intent);
                } catch(e) {
                    tg.showAlert("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR");
                    Router.back();
                }
            },

            poll(sid, intent) {
                let attempts = 0;
                // Backoff strategy: 1s, 2s, 3s, 5s, 5s...
                const delays = [1000, 2000, 3000, 5000];
                
                const check = async () => {
                    if(!document.getElementById('view-qr').classList.contains('active')) return;
                    
                    try {
                        const res = await API.call('check-status', { session_id: sid });
                        const data = Array.isArray(res) ? res[0] : res;
                        
                        if(data.status === 'USED') {
                            tg.HapticFeedback.notificationOccurred('success');
                            
                            // Update local state
                            State.activeBusiness.balance = data.balance;
                            State.activeBusiness.bonus_cups = data.bonus_cups;
                            
                            // Replace current history to home, then show success
                            Router.history.pop(); 
                            document.querySelectorAll('.page').forEach(v => v.classList.remove('active'));
                            
                            // Show Success View instead of Home
                            Router.go('success');
                            return;
                        }
                    } catch(e) {}

                    attempts++;
                    const delay = delays[Math.min(attempts, delays.length-1)];
                    this.interval = setTimeout(check, delay);
                };
                
                check();
            },

            stop() {
                if(this.interval) clearTimeout(this.interval);
            }
        };

        // --- ADMIN MANAGER ---
        const AdminManager = {
            sessionId: null,

            scan() {
                tg.showScanQrPopup({ text: "–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–ª–∏–µ–Ω—Ç–∞" }, async (text) => {
                    tg.closeScanQrPopup();
                    try {
                        const json = JSON.parse(text);
                        if(!json.sid) throw new Error();
                        
                        tg.MainButton.showProgress();
                        const res = await API.call('scan-qr', { qr_session: json.sid });
                        tg.MainButton.hideProgress();
                        
                        const r = Array.isArray(res) ? res[0].result : res.result;

                        if(r.status === 'success') {
                            tg.showAlert(r.message);
                        } else if (r.status === 'confirmation_required') {
                            this.sessionId = json.sid;
                            document.getElementById('modal-conflict').classList.remove('hidden');
                        } else {
                            tg.showAlert(r.message || "–û—à–∏–±–∫–∞");
                        }
                    } catch(e) {
                        tg.showAlert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π QR");
                    }
                    return true;
                });
            },

            async resolve(action) {
                document.getElementById('modal-conflict').classList.add('hidden');
                try {
                    const res = await API.call('scan-qr', { qr_session: this.sessionId, action });
                    const r = Array.isArray(res) ? res[0].result : res.result;
                    tg.showAlert(r.message);
                } catch(e) {
                    tg.showAlert("–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è");
                }
            },

            showInvite() {
                const b = State.activeBusiness;
                const link = `https://t.me/${BOT_USERNAME}/app?startapp=${b.id}`;
                document.getElementById('invite-link').innerText = link;
                document.getElementById('invite-qr').innerHTML = '';
                new QRCode(document.getElementById("invite-qr"), {
                    text: link, width: 180, height: 180
                });
                document.getElementById('modal-invite').classList.remove('hidden');
            },

            initSettings() {
                const b = State.activeBusiness;
                // We need to fetch full config maybe? or use partial from State
                document.getElementById('set-name').value = b.name;
                document.getElementById('set-color').value = b.theme_color || '#2563EB';
                document.getElementById('set-color-val').innerText = b.theme_color || '#2563EB';
                
                document.getElementById('set-color').addEventListener('input', (e) => {
                     document.getElementById('set-color-val').innerText = e.target.value;
                });
                this.selectTarget(b.target_count || 6);
            },
            
            selectTarget(n) {
                State.tempTarget = n;
                document.querySelectorAll('.target-btn').forEach(b => {
                    if(parseInt(b.dataset.val) === n) b.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-600');
                    else b.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-600');
                });
            },

            async save() {
                const b = State.activeBusiness;
                const body = {
                    settings: {
                        name: document.getElementById('set-name').value,
                        config: {
                            theme_color: document.getElementById('set-color').value,
                            target_count: State.tempTarget
                        }
                    }
                };
                
                try {
                    await API.call('save-settings', body);
                    tg.showAlert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
                    
                    // Update Local State
                    const ownedRef = State.owned.find(o => o.id === b.id);
                    if(ownedRef) {
                        ownedRef.name = body.settings.name;
                        ownedRef.config.theme_color = body.settings.config.theme_color;
                        ownedRef.config.target_count = body.settings.config.target_count;
                    }
                    Router.back();
                } catch(e) {
                    tg.showAlert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
                }
            }
        };

        // --- BOOTSTRAP ---
        async function start() {
            tg.expand();
            tg.BackButton.onClick(() => Router.back());

            const user = tg.initDataUnsafe?.user;
            if(!user) {
                document.getElementById('stub-view').classList.remove('hidden');
                document.getElementById('loader').classList.add('hidden');
                document.body.style.visibility = 'visible';
                document.body.style.opacity = '1';
                return;
            }
            State.user = user;

            const startParam = tg.initDataUnsafe?.start_param || "";

            try {
                const res = await API.call('init-app', { start_param: startParam });
                let data = Array.isArray(res) ? res[0] : res;
                if (data.data) data = data.data; // Unwrap n8n wrapper
                else if (data.register_or_get_customer) data = data.register_or_get_customer;
                
                // [FIX v1.7] Compatible parsing
                State.owned = data.owned_businesses || [];
                State.member = data.member_businesses || data.wallets || [];
                
                const isOwner = State.owned.length > 0;
                const isMember = State.member.length > 0;
                const targetId = data.target_business_id;

                // 1. Target ID (Deep Link)
                if (targetId) {
                    const targetBiz = State.member.find(m => m.business_id === targetId);
                    if (targetBiz) {
                        enterBusiness(targetBiz);
                        return;
                    }
                    // If target business is owned but not joined as member?
                    const ownedBiz = State.owned.find(o => o.id === targetId);
                    if(ownedBiz) {
                         enterAdmin(ownedBiz);
                         return;
                    }
                }

                // 2. Hybrid Dashboard
                if (isOwner && isMember) {
                    showDashboard();
                }
                // 3. Pure Owner
                else if (isOwner) {
                    // If 1 business -> Auto Enter Admin, else Dashboard
                    if(State.owned.length === 1) enterAdmin(State.owned[0]);
                    else showDashboard();
                }
                // 4. Pure Customer
                else if (isMember) {
                    if (State.member.length === 1) enterBusiness(State.member[0]);
                    else showDashboard();
                }
                // 5. New User
                else {
                    showDashboard(); // Will show empty state
                }

            } catch(e) {
                console.error(e);
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('view-error').classList.remove('hidden');
                document.body.style.visibility = 'visible';
                document.body.style.opacity = '1';
            }
        }
        
        // Helpers for Router logic
        function showDashboard() {
            document.getElementById('loader').classList.add('hidden');
            document.body.style.visibility = 'visible';
            document.body.style.opacity = '1';
            Router.go('dashboard');
        }
        
        function enterBusiness(biz) {
            State.activeBusiness = {
                id: biz.business_id,
                name: biz.name,
                role: 'customer',
                theme_color: biz.theme,
                target_count: biz.target,
                logo_url: biz.logo,
                balance: biz.balance,
                bonus_cups: biz.bonus_cups
            };
            UIManager.applyTheme(State.activeBusiness);
            document.getElementById('loader').classList.add('hidden');
            document.body.style.visibility = 'visible';
            document.body.style.opacity = '1';
            Router.go('home');
        }
        
        function enterAdmin(biz) {
             State.activeBusiness = { ...biz, role: 'admin' };
             // Flat map config for easier access
             if(biz.config) {
                 State.activeBusiness.theme_color = biz.config.theme_color;
                 State.activeBusiness.target_count = biz.config.target_count;
                 State.activeBusiness.logo_url = biz.config.logo_url;
             }
             UIManager.applyTheme(State.activeBusiness);
             document.getElementById('loader').classList.add('hidden');
             document.body.style.visibility = 'visible';
             document.body.style.opacity = '1';
             Router.go('admin');
        }

        start();
    </script>
</body>
</html>
