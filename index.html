<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loyalty Wallet</title>
    
    <!-- Dependencies (Original) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- DYNAMIC THEME ENGINE (Original) --- */
        :root {
            --theme-color: #F59E0B; 
            --theme-bg: #FFFBEB;    
            --theme-text: #B45309;  
        }
        .bg-theme { background-color: var(--theme-color) !important; }
        .bg-theme-soft { background-color: var(--theme-bg) !important; }
        .text-theme { color: var(--theme-color) !important; }
        .border-theme { border-color: var(--theme-color) !important; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #F9FAFB;
        }

        /* Views management */
        .view { display: none; padding-bottom: 80px; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-900 bg-gray-50 min-h-screen">

    <!-- LOADER -->
    <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
        <div class="w-12 h-12 border-4 border-gray-100 border-t-amber-500 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-400 text-sm font-medium animate-pulse">Загрузка...</p>
    </div>

    <!-- ERROR -->
    <div id="view-error" class="hidden fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-8 text-center">
        <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-4">
            <i data-lucide="wifi-off" class="w-8 h-8"></i>
        </div>
        <h2 class="text-xl font-bold mb-2">Ошибка связи</h2>
        <p class="text-gray-500 mb-6">Не удалось загрузить данные.</p>
        <button onclick="window.location.reload()" class="px-6 py-3 bg-gray-900 text-white rounded-xl font-bold">Повторить</button>
    </div>

    <!-- [NEW] DASHBOARD VIEW (Hybrid Hub) -->
    <div id="view-dashboard" class="view px-5 py-6">
        <h1 class="text-2xl font-black mb-6">Мои карты</h1>
        
        <!-- Admin Section -->
        <div id="dash-admin-block" class="mb-8 hidden">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Мой бизнес</p>
            <div id="dash-admin-list" class="space-y-3"></div>
        </div>

        <!-- Wallet Section -->
        <div>
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Кошелек</p>
            <div id="dash-wallet-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- [ORIGINAL] WALLET VIEW -->
    <div id="view-wallet" class="view px-5 py-6">
        <h1 class="text-2xl font-black mb-6">Мои карты</h1>
        <div id="wallet-list" class="space-y-4"></div>
        <div id="wallet-empty" class="hidden text-center py-10">
            <p class="text-gray-400">У вас пока нет карт лояльности.</p>
        </div>
    </div>

    <!-- [ORIGINAL] HOME VIEW -->
    <div id="view-home" class="view px-5 py-6 relative min-h-screen flex flex-col">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 id="business-name" class="text-2xl font-black leading-tight">Кофейня</h1>
                <p class="text-gray-500 text-sm">Соберите 6 штампов — кофе в подарок!</p>
            </div>
            <!-- Admin Button -->
            <button id="btn-admin-panel" onclick="Router.go('admin')" class="hidden w-10 h-10 bg-gray-900 text-white rounded-full flex items-center justify-center shadow-lg active:scale-95">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
            <div id="user-icon-placeholder" class="w-10 h-10 bg-gray-200 rounded-full"></div>
        </div>

        <!-- Balance Card -->
        <div class="bg-gray-900 rounded-3xl p-6 text-white shadow-xl shadow-gray-300 mb-8 relative overflow-hidden">
            <div class="relative z-10">
                <p class="text-gray-400 text-xs font-bold uppercase mb-1">Ваш баланс</p>
                <div class="flex items-baseline gap-1">
                    <span id="balance-count" class="text-5xl font-black tracking-tighter">0</span>
                    <span class="text-gray-500 text-xl font-medium">/ <span id="target-count">6</span></span>
                </div>
            </div>
        </div>

        <!-- Grid -->
        <div id="stamps-grid" class="grid grid-cols-3 gap-4 mb-auto"></div>

        <!-- Actions -->
        <div class="mt-8 grid grid-cols-2 gap-3">
            <button onclick="QRManager.show('EARN')" class="bg-theme text-white p-4 rounded-2xl font-bold shadow-lg shadow-theme/30 flex flex-col items-center gap-2 active:scale-95 transition-transform">
                <i data-lucide="qr-code" class="w-6 h-6"></i>
                <span>Получить</span>
            </button>
            <button onclick="Router.go('rewards')" class="bg-white border border-gray-100 p-4 rounded-2xl font-bold shadow-sm flex flex-col items-center gap-2 active:scale-95 transition-transform relative">
                <div id="badge-rewards" class="hidden absolute top-3 right-3 w-2 h-2 bg-red-500 rounded-full"></div>
                <i data-lucide="gift" class="w-6 h-6 text-gray-400"></i>
                <span>Награды</span>
            </button>
        </div>
    </div>

    <!-- [ORIGINAL] REWARDS VIEW -->
    <div id="view-rewards" class="view px-5 py-6">
        <button onclick="Router.back()" class="mb-4 flex items-center text-gray-400"><i data-lucide="chevron-left" class="w-5 h-5"></i> Назад</button>
        <h1 class="text-2xl font-black mb-2">Ваши награды</h1>
        <p class="text-gray-500 mb-8">Обменяйте накопленные бонусы.</p>
        
        <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm text-center">
            <div class="w-16 h-16 bg-theme-soft rounded-full flex items-center justify-center mx-auto mb-4 text-theme">
                <i data-lucide="coffee" class="w-8 h-8"></i>
            </div>
            <h3 class="font-bold text-lg mb-1">Бесплатный напиток</h3>
            <p class="text-sm text-gray-400 mb-6">Стоимость: 1 бонус</p>
            <div class="flex items-center justify-center gap-2 mb-6">
                <span class="text-3xl font-black" id="bonus-balance">0</span>
                <span class="text-gray-400 text-sm">доступно</span>
            </div>
            <button id="btn-redeem" onclick="QRManager.show('REDEEM')" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                Списать
            </button>
        </div>
    </div>

    <!-- [ORIGINAL] QR MODAL -->
    <div id="modal-qr" class="hidden fixed inset-0 z-[100] bg-gray-900 text-white flex flex-col px-6 py-10">
        <button onclick="QRManager.hide()" class="absolute top-6 right-6 p-2 bg-white/10 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button>
        <div class="flex-1 flex flex-col items-center justify-center text-center">
            <h2 id="qr-title" class="text-2xl font-bold mb-2">Сканируйте QR</h2>
            <p class="text-gray-400 mb-8 text-sm">Покажите этот код сотруднику</p>
            
            <div class="bg-white p-4 rounded-3xl mb-8 relative">
                <div id="qrcode"></div>
                <!-- Loader inside QR -->
                <div id="qr-loader" class="absolute inset-0 bg-white flex items-center justify-center rounded-3xl">
                    <div class="w-8 h-8 border-4 border-gray-200 border-t-gray-800 rounded-full animate-spin"></div>
                </div>
            </div>
            <p class="text-xs text-gray-500 animate-pulse">Ожидание сканирования...</p>
        </div>
    </div>

    <!-- [ORIGINAL] ADMIN PANEL -->
    <div id="view-admin" class="view px-5 py-6">
        <button onclick="Router.back()" class="mb-6 flex items-center text-gray-400"><i data-lucide="chevron-left" class="w-5 h-5"></i> Назад</button>
        <h1 class="text-2xl font-black mb-8">Администрирование</h1>
        
        <div class="grid gap-4">
            <button onclick="AdminManager.scan()" class="bg-gray-900 text-white p-6 rounded-3xl shadow-xl flex items-center justify-between group active:scale-95 transition-transform">
                <div class="text-left">
                    <p class="font-bold text-lg">Сканировать</p>
                    <p class="text-gray-400 text-sm">Начислить или списать</p>
                </div>
                <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center group-hover:bg-white/20 transition-colors">
                    <i data-lucide="scan-line" class="w-6 h-6"></i>
                </div>
            </button>

            <button onclick="Router.go('settings')" class="bg-white border border-gray-200 p-6 rounded-3xl shadow-sm flex items-center justify-between active:scale-95 transition-transform">
                <div class="text-left">
                    <p class="font-bold text-gray-900">Настройки</p>
                    <p class="text-gray-400 text-sm">Внешний вид и условия</p>
                </div>
                <i data-lucide="sliders" class="w-6 h-6 text-gray-300"></i>
            </button>
        </div>
    </div>

    <!-- [ORIGINAL] SETTINGS VIEW -->
    <div id="view-settings" class="view px-5 py-6">
        <button onclick="Router.back()" class="mb-6 flex items-center text-gray-400"><i data-lucide="chevron-left" class="w-5 h-5"></i> Назад</button>
        <h1 class="text-2xl font-black mb-6">Настройки</h1>
        
        <div class="space-y-6">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Название бизнеса</label>
                <input id="set-name" type="text" class="w-full p-4 bg-white border border-gray-200 rounded-xl font-medium focus:border-amber-500 outline-none transition-colors">
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Основной цвет</label>
                <div class="flex gap-3 overflow-x-auto py-2 no-scrollbar">
                    <button onclick="AdminManager.setColor('#F59E0B', '#FFFBEB')" class="w-12 h-12 rounded-full bg-amber-500 border-2 border-transparent focus:border-gray-900 flex-shrink-0"></button>
                    <button onclick="AdminManager.setColor('#EF4444', '#FEF2F2')" class="w-12 h-12 rounded-full bg-red-500 border-2 border-transparent focus:border-gray-900 flex-shrink-0"></button>
                    <button onclick="AdminManager.setColor('#3B82F6', '#EFF6FF')" class="w-12 h-12 rounded-full bg-blue-500 border-2 border-transparent focus:border-gray-900 flex-shrink-0"></button>
                    <button onclick="AdminManager.setColor('#10B981', '#ECFDF5')" class="w-12 h-12 rounded-full bg-emerald-500 border-2 border-transparent focus:border-gray-900 flex-shrink-0"></button>
                    <button onclick="AdminManager.setColor('#8B5CF6', '#F5F3FF')" class="w-12 h-12 rounded-full bg-violet-500 border-2 border-transparent focus:border-gray-900 flex-shrink-0"></button>
                    <button onclick="AdminManager.setColor('#111827', '#F3F4F6')" class="w-12 h-12 rounded-full bg-gray-900 border-2 border-transparent focus:border-gray-900 flex-shrink-0"></button>
                </div>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">Цель (штампов)</label>
                <div class="flex bg-gray-100 p-1 rounded-xl">
                    <button onclick="AdminManager.setTarget(6)" id="t-6" class="flex-1 py-3 rounded-lg text-sm font-bold transition-all bg-white shadow-sm">6</button>
                    <button onclick="AdminManager.setTarget(8)" id="t-8" class="flex-1 py-3 rounded-lg text-sm font-bold text-gray-500 transition-all">8</button>
                    <button onclick="AdminManager.setTarget(10)" id="t-10" class="flex-1 py-3 rounded-lg text-sm font-bold text-gray-500 transition-all">10</button>
                    <button onclick="AdminManager.setTarget(12)" id="t-12" class="flex-1 py-3 rounded-lg text-sm font-bold text-gray-500 transition-all">12</button>
                </div>
            </div>

            <button onclick="AdminManager.save()" class="w-full py-4 bg-gray-900 text-white rounded-xl font-bold text-lg mt-4 active:scale-95 transition-transform">
                Сохранить
            </button>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- CONFIG ---
        const API_BASE = 'https://n8n.inflio.xyz/webhook'; 
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- STATE ---
        const State = {
            user: null,
            mode: 'loading', // 'wallet', 'business', 'dashboard'
            businessId: null, // Current active business
            owned: [], // List of businesses I own
            wallets: [], // List of cards I have
            
            // Current Business Context
            config: { target_count: 6, theme_color: '#F59E0B', bg_color: '#FFFBEB' },
            balance: 0,
            bonusCups: 0,
            
            // Temporary
            tempColor: null,
            tempBg: null,
            tempTarget: 6,
            qrInterval: null
        };

        // --- ROUTER ---
        const Router = {
            history: [],
            go(viewId) {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');
                this.history.push(viewId);
                
                if (viewId === 'home') UIManager.renderHome();
                if (viewId === 'rewards') UIManager.renderRewards();
                if (viewId === 'settings') AdminManager.initUI();
                
                if (this.history.length > 1) tg.BackButton.show(); else tg.BackButton.hide();
                setTimeout(() => lucide.createIcons(), 50);
            },
            back() {
                if(this.history.length <= 1) return;
                this.history.pop();
                const prev = this.history[this.history.length - 1];
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${prev}`).classList.add('active');
                if (this.history.length <= 1) tg.BackButton.hide();
            }
        };
        tg.BackButton.onClick(() => Router.back());

        // --- API (ORIGINAL SIMPLE FETCH) ---
        const API = {
            async call(endpoint, body = {}) {
                const headers = { 'Content-Type': 'application/json', 'X-Telegram-Auth': tg.initData };
                // Using Original URL construction
                let url = `${API_BASE}/${endpoint}`; 
                // Fix for GET requests if needed, but original used POST mostly. 
                // Let's stick to simple fetch
                const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
                if(!res.ok) throw new Error('API Error');
                return await res.json();
            }
        };

        // --- UI MANAGER ---
        const UIManager = {
            applyTheme(cfg) {
                const r = document.documentElement.style;
                r.setProperty('--theme-color', cfg.theme_color);
                r.setProperty('--theme-bg', cfg.bg_color);
                tg.setHeaderColor(cfg.theme_color);
            },
            renderHome() {
                document.getElementById('business-name').innerText = State.config.name || 'Кофейня';
                document.getElementById('balance-count').innerText = State.balance;
                document.getElementById('target-count').innerText = State.config.target_count;
                
                // Render Grid
                const grid = document.getElementById('stamps-grid');
                grid.innerHTML = '';
                for(let i=1; i<=State.config.target_count; i++) {
                    const active = i <= State.balance;
                    const el = document.createElement('div');
                    el.className = `aspect-square rounded-2xl flex items-center justify-center text-lg font-bold transition-all ${active ? 'bg-theme text-white shadow-lg shadow-theme/30 scale-105' : 'bg-white border border-gray-100 text-gray-300'}`;
                    el.innerHTML = active ? '<i data-lucide="coffee" class="w-6 h-6"></i>' : i;
                    grid.appendChild(el);
                }
                
                // Badge
                if(State.bonusCups > 0) document.getElementById('badge-rewards').classList.remove('hidden');
                else document.getElementById('badge-rewards').classList.add('hidden');
            },
            renderRewards() {
                document.getElementById('bonus-balance').innerText = State.bonusCups;
                document.getElementById('btn-redeem').disabled = State.bonusCups <= 0;
            }
        };

        // --- QR MANAGER (ORIGINAL LOGIC) ---
        const QRManager = {
            async show(intent) {
                document.getElementById('modal-qr').classList.remove('hidden');
                document.getElementById('qr-loader').classList.remove('hidden');
                document.getElementById('qr-title').innerText = intent === 'EARN' ? 'Получить штамп' : 'Списать бонус';
                
                try {
                    // Original API Call
                    const res = await API.call('get-qr', { 
                        intent, 
                        business_id: State.businessId // Important!
                    });
                    
                    // Simple parsing as in original v1.0
                    const session = Array.isArray(res) ? res[0] : res; 
                    
                    // Generate QR
                    document.getElementById('qrcode').innerHTML = '';
                    new QRCode(document.getElementById("qrcode"), {
                        text: JSON.stringify({ sid: session.session_id }),
                        width: 200, height: 200,
                        colorDark : "#000000",
                        colorLight : "#ffffff"
                    });
                    document.getElementById('qr-loader').classList.add('hidden');
                    
                    // Start Polling
                    this.poll(session.session_id);
                    
                } catch(e) {
                    console.error(e);
                    this.hide();
                    tg.showAlert('Ошибка генерации QR');
                }
            },
            hide() {
                document.getElementById('modal-qr').classList.add('hidden');
                if(State.qrInterval) clearTimeout(State.qrInterval);
            },
            poll(sid) {
                // Simple Polling 2.5s
                State.qrInterval = setTimeout(async () => {
                    try {
                        const res = await API.call('check-status', { session_id: sid });
                        const data = Array.isArray(res) ? res[0] : res;
                        
                        if(data.status === 'USED') {
                            tg.HapticFeedback.notificationOccurred('success');
                            // Update Local State
                            State.balance = data.balance;
                            State.bonusCups = data.bonus_cups;
                            this.hide();
                            Router.go('home'); // Refresh
                            tg.showAlert('Успешно!');
                        } else {
                            this.poll(sid); // Continue
                        }
                    } catch(e) { this.poll(sid); }
                }, 2500);
            }
        };

        // --- ADMIN MANAGER ---
        const AdminManager = {
            scan() {
                tg.showScanQrPopup({ text: "Наведите на QR клиента" }, async (text) => {
                    tg.closeScanQrPopup();
                    try {
                        const json = JSON.parse(text);
                        tg.MainButton.showProgress();
                        
                        // Original Scan Call
                        const res = await API.call('scan-qr', { qr_session: json.sid });
                        tg.MainButton.hideProgress();
                        
                        // Simple Alert Logic
                        const r = Array.isArray(res) ? res[0].result : res.result;
                        tg.showAlert(r.message || JSON.stringify(r));
                        
                    } catch(e) {
                        tg.showAlert("Ошибка: " + e.message);
                    }
                    return true;
                });
            },
            initUI() {
                document.getElementById('set-name').value = State.config.name || '';
                this.setTarget(State.config.target_count || 6);
                // Color logic is simplified for demo
            },
            setColor(c, bg) {
                State.tempColor = c; State.tempBg = bg;
                tg.HapticFeedback.selectionChanged();
                // Visual feedback omitted for brevity in "Original" restore
            },
            setTarget(n) {
                State.tempTarget = n;
                [6,8,10,12].forEach(i => {
                    const el = document.getElementById(`t-${i}`);
                    if(i === n) el.className = "flex-1 py-3 rounded-lg text-sm font-bold transition-all bg-white shadow-sm text-black";
                    else el.className = "flex-1 py-3 rounded-lg text-sm font-bold text-gray-500 transition-all";
                });
            },
            async save() {
                const newConfig = {
                    name: document.getElementById('set-name').value,
                    config: {
                        theme_color: State.tempColor || State.config.theme_color,
                        bg_color: State.tempBg || State.config.bg_color,
                        target_count: State.tempTarget
                    }
                };
                
                try {
                    await API.call('save-settings', { settings: newConfig });
                    State.config = { ...State.config, ...newConfig.config, name: newConfig.name };
                    UIManager.applyTheme(State.config);
                    tg.showAlert('Сохранено!');
                    Router.back();
                } catch(e) {
                    tg.showAlert('Ошибка сохранения');
                }
            }
        };

        // --- BOOTSTRAP (MODIFIED FOR HYBRID) ---
        async function bootstrap() {
            const user = tg.initDataUnsafe?.user;
            // if(!user) ... (Stub removed for clean original code)
            State.user = user;

            try {
                // Call Init
                const startParam = tg.initDataUnsafe?.start_param || "";
                // Use GET params as in original n8n setup usually require special handling
                // But here we used POST in original file provided in chat history snippets.
                // Assuming POST is fine as per your "Original" request.
                const res = await API.call('init-app', { start_param: startParam });
                const data = Array.isArray(res) ? res[0] : res; // Standard n8n unwrap

                // --- HYBRID LOGIC INJECTION ---
                State.owned = data.owned_businesses || [];
                State.wallets = data.member_businesses || data.wallets || [];
                
                // 1. Deep Link Priority
                if (data.target_business_id) {
                    enterBusiness(data.target_business_id, State.wallets);
                    return;
                }

                // 2. Hybrid Dashboard Check
                const isOwner = State.owned.length > 0;
                const isClient = State.wallets.length > 0;

                if (isOwner && isClient) {
                    renderDashboard(State.owned, State.wallets);
                    return;
                }
                
                if (isOwner) {
                    // Only Owner
                    if(State.owned.length === 1) {
                        enterAdminContext(State.owned[0]);
                    } else {
                        renderDashboard(State.owned, []); // Show list of owned
                    }
                    return;
                }

                // 3. Fallback to Original Logic (Single Wallet)
                if (isClient) {
                    if (State.wallets.length === 1) {
                        enterBusiness(State.wallets[0].business_id, State.wallets);
                    } else {
                        renderWalletList(State.wallets);
                    }
                } else {
                    // New user
                    renderWalletList([]); 
                }

            } catch(e) {
                console.error(e);
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('view-error').classList.remove('hidden');
            }
        }

        // --- HELPERS ---
        
        function renderDashboard(owned, wallets) {
            document.getElementById('loader').classList.add('hidden');
            const adminList = document.getElementById('dash-admin-list');
            const walletList = document.getElementById('dash-wallet-list');
            
            if(owned.length > 0) {
                document.getElementById('dash-admin-block').classList.remove('hidden');
                adminList.innerHTML = owned.map(b => `
                    <div onclick='enterAdminContext(${JSON.stringify(b)})' class="bg-gray-900 text-white p-4 rounded-2xl flex items-center justify-between shadow-lg">
                        <span class="font-bold">${b.name}</span>
                        <i data-lucide="chevron-right"></i>
                    </div>
                `).join('');
            }

            if(wallets.length > 0) {
                walletList.innerHTML = wallets.map(w => `
                    <div onclick='enterBusiness("${w.business_id}", ${JSON.stringify(wallets)})' class="bg-white p-4 rounded-2xl border shadow-sm flex justify-between items-center">
                        <div>
                            <p class="font-bold">${w.name}</p>
                            <p class="text-xs text-gray-500">${w.balance}/${w.target}</p>
                        </div>
                        <i data-lucide="chevron-right" class="text-gray-300"></i>
                    </div>
                `).join('');
            } else {
                walletList.innerHTML = `<p class="text-center text-gray-400 py-4">Нет карт</p>`;
            }
            
            Router.go('dashboard');
        }

        function renderWalletList(wallets) {
            document.getElementById('loader').classList.add('hidden');
            if(wallets.length === 0) {
                document.getElementById('wallet-empty').classList.remove('hidden');
                Router.go('wallet');
                return;
            }
            // Reuse dashboard logic for simplicity in original style
            renderDashboard([], wallets);
        }

        function enterBusiness(bizId, walletsList) {
            const biz = walletsList.find(w => w.business_id === bizId);
            if(!biz) return;
            
            State.businessId = bizId;
            State.balance = biz.balance;
            State.bonusCups = biz.bonus_cups;
            State.config = { 
                name: biz.name, 
                target_count: biz.target, 
                theme_color: biz.theme || '#F59E0B', 
                bg_color: '#FFFBEB' 
            };
            
            // Check if I am also admin of THIS business (Contextual)
            const isAlsoAdmin = State.owned.some(o => o.id === bizId);
            if(isAlsoAdmin) document.getElementById('btn-admin-panel').classList.remove('hidden');
            
            UIManager.applyTheme(State.config);
            document.getElementById('loader').classList.add('hidden');
            Router.go('home');
        }

        function enterAdminContext(biz) {
            State.businessId = biz.id;
            State.config = { 
                name: biz.name, 
                ...biz.config 
            };
            UIManager.applyTheme(State.config);
            document.getElementById('loader').classList.add('hidden');
            Router.go('admin');
        }

        bootstrap();
    </script>
</body>
</html>


