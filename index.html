<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Loyalty Wallet</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --theme-color: #F59E0B;
            --theme-bg: #FFFBEB;
            --theme-text: #B45309;
        }
        .bg-theme { background-color: var(--theme-color) !important; }
        .bg-theme-soft { background-color: var(--theme-bg) !important; }
        .text-theme { color: var(--theme-color) !important; }
        .text-theme-dark { color: var(--theme-text) !important; }
        .border-theme { border-color: var(--theme-color) !important; }
        .shadow-theme { --tw-shadow-color: var(--theme-color) !important; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #F9FAFB;
        }

        .page {
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), opacity 0.3s ease;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow-y: auto;
            background: #F9FAFB;
            display: none;
            flex-direction: column;
        }
        .page.active { display: flex; z-index: 10; }
        
        .stamp-enter { animation: stamp-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes stamp-pop { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-gray-900 h-screen overflow-hidden relative">

    <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white transition-opacity duration-500">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-gray-800 rounded-full animate-spin mb-4"></div>
        <p class="text-gray-400 text-sm font-medium animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>

    <div id="stub-view" class="hidden fixed inset-0 z-[60] bg-gray-50 flex flex-col items-center justify-center p-6 text-center">
        <i data-lucide="smartphone" class="w-16 h-16 text-gray-300 mb-4"></i>
        <h2 class="text-xl font-bold mb-2">–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</h2>
    </div>

    <div id="view-error" class="hidden fixed inset-0 z-[60] bg-white flex flex-col items-center justify-center p-8 text-center">
        <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-4">
            <i data-lucide="wifi-off" class="w-8 h-8"></i>
        </div>
        <h2 class="text-xl font-bold mb-2">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏</h2>
        <button onclick="window.location.reload()" class="px-6 py-3 bg-gray-900 text-white rounded-xl font-bold active:scale-95 transition-transform">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
    </div>

    <!-- 0. WALLET VIEW -->
    <div id="view-wallet" class="page px-5 py-6">
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-black text-gray-900">–ö–æ—à–µ–ª–µ–∫</h1>
            <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                <i data-lucide="wallet" class="w-5 h-5 text-gray-500"></i>
            </div>
        </header>

        <div id="wallet-group-owners" class="hidden mb-8">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">–ú–æ–π –ë–∏–∑–Ω–µ—Å</h3>
            <div id="wallet-list-owners" class="space-y-3"></div>
        </div>

        <div id="wallet-group-clients" class="hidden">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">–ú–æ–∏ –ö–∞—Ä—Ç—ã</h3>
            <div id="wallet-list-clients" class="space-y-3"></div>
        </div>

        <div id="wallet-empty" class="hidden flex flex-col items-center justify-center mt-20 text-center">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4"><i data-lucide="scan-line" class="w-10 h-10 text-gray-400"></i></div>
            <h3 class="text-lg font-bold text-gray-800">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ä—Ç</h3>
        </div>
    </div>

    <!-- 1. HOME VIEW -->
    <div id="view-home" class="page px-5 py-6">
        <header class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-3">
                <button id="btn-back-wallet" onclick="Router.go('wallet')" class="hidden p-1 -ml-1 text-gray-400 active:scale-90 transition-transform">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                <img id="app-logo" src="" class="w-12 h-12 rounded-full object-cover border-2 border-gray-100 shadow-sm bg-white">
                <div>
                    <h1 id="app-title" class="text-xl font-black text-gray-800 tracking-tight leading-tight">...</h1>
                    <p id="user-name" class="text-xs text-gray-500 font-medium">...</p>
                </div>
            </div>
            
            <button id="btn-admin-panel" onclick="Router.go('admin')" class="hidden w-10 h-10 bg-gray-900 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
            <div id="user-icon-placeholder" class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden"><i data-lucide="user" class="w-5 h-5 text-gray-500"></i></div>
        </header>

        <div class="bg-gray-900 rounded-3xl p-6 text-white shadow-xl shadow-gray-200 mb-6 relative overflow-hidden group">
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-theme opacity-20 rounded-full blur-3xl group-hover:opacity-30 transition-opacity"></div>
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">–í–∞—à —Å—Ç–∞—Ç—É—Å</p>
                        <p id="user-rank" class="text-2xl font-bold text-theme">–ù–æ–≤–∏—á–æ–∫</p>
                    </div>
                    <div class="text-right">
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">–ë–∞–ª–∞–Ω—Å</p>
                        <p class="text-2xl font-bold"><span id="user-balance">0</span><span class="text-gray-500 text-lg">/<span id="target-count-display">6</span></span></p>
                    </div>
                </div>
                <div class="bg-white/10 rounded-2xl p-4 flex justify-between items-center backdrop-blur-md border border-white/5">
                    <span class="text-sm font-medium text-gray-300">–î–æ –±–æ–Ω—É—Å–∞ <span id="reward-name-display">...</span>:</span>
                    <span id="stamps-left" class="font-bold text-theme text-xl">6</span>
                </div>
            </div>
        </div>

        <button onclick="Router.go('bonuses')" class="w-full mb-6 py-4 bg-theme-soft border border-theme/20 rounded-2xl flex items-center justify-between px-6 shadow-sm active:scale-95 transition-transform group">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-theme text-white rounded-full flex items-center justify-center shadow-lg shadow-theme/30"><i data-lucide="gift" class="w-5 h-5"></i></div>
                <div class="text-left"><p class="font-bold text-gray-800">–ú–æ–∏ –±–æ–Ω—É—Å—ã</p><p class="text-xs text-theme-dark font-medium" id="home-bonus-count">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö</p></div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 group-hover:text-theme transition-colors"></i>
        </button>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="Router.go('card')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform">
                <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center"><i data-lucide="credit-card" class="w-6 h-6"></i></div>
                <span class="font-bold text-gray-700">–ú–æ—è –∫–∞—Ä—Ç–∞</span>
            </button>
            <button onclick="Router.go('qr', 'EARN')" class="bg-theme p-5 rounded-2xl shadow-lg shadow-theme/30 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform text-white">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center"><i data-lucide="qr-code" class="w-6 h-6"></i></div>
                <span class="font-bold">–ü–æ–∫–∞–∑–∞—Ç—å QR</span>
            </button>
            <button onclick="Router.go('contacts')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform">
                <div class="w-12 h-12 bg-green-50 text-green-600 rounded-full flex items-center justify-center"><i data-lucide="phone" class="w-6 h-6"></i></div>
                <span class="font-bold text-gray-700">–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
            </button>
            <button onclick="Router.go('help')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform">
                <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-full flex items-center justify-center"><i data-lucide="help-circle" class="w-6 h-6"></i></div>
                <span class="font-bold text-gray-700">–ü–æ–º–æ—â—å</span>
            </button>
        </div>
    </div>

    <!-- 2. BONUSES & CARD VIEWS (Standard) -->
    <div id="view-bonuses" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center mb-8">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900 active:scale-90 transition-transform"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ú–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
        </div>
        <div class="flex-1 flex flex-col items-center">
            <div class="w-full bg-gray-900 text-white rounded-2xl p-6 shadow-xl mb-6 flex justify-between items-center">
                <div><p class="text-gray-400 text-xs mb-1">–í–∞—à —Å—Ç–∞—Ç—É—Å</p><h3 id="bonus-rank" class="text-2xl font-bold text-theme">–ù–æ–≤–∏—á–æ–∫</h3></div>
                <div class="text-4xl">üèÜ</div>
            </div>
            <div class="w-full bg-theme-soft border border-theme/20 rounded-3xl p-8 text-center mb-auto flex flex-col items-center justify-center">
                <div class="w-20 h-20 bg-white text-theme rounded-full flex items-center justify-center mb-4 shadow-sm"><i data-lucide="gift" class="w-10 h-10"></i></div>
                <p class="text-theme-dark font-medium mb-2">–î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏</p>
                <div class="text-6xl font-black text-theme mb-4" id="bonus-cups-display">0</div>
            </div>
            <button id="btn-use-bonus" onclick="Router.go('qr', 'REDEEM')" class="w-full py-4 bg-theme text-white text-lg font-bold rounded-xl shadow-lg shadow-theme/30 active:scale-95 transition-transform flex items-center justify-center gap-2"><i data-lucide="qr-code" class="w-5 h-5"></i> –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å</button>
        </div>
    </div>

    <div id="view-card" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center mb-8">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900 active:scale-90 transition-transform"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ë–æ–Ω—É—Å–Ω–∞—è –∫–∞—Ä—Ç–∞</h2>
        </div>
        <div class="bg-white rounded-3xl p-6 shadow-xl shadow-gray-100 border border-gray-100 flex-1 flex flex-col items-center">
            <div id="stamps-container" class="grid grid-cols-3 gap-4 w-full mb-auto place-items-center"></div>
            <button onclick="Router.go('qr', 'EARN')" class="w-full py-4 mt-8 bg-gray-900 text-white font-bold rounded-xl active:scale-95 transition-transform shadow-lg">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</button>
        </div>
    </div>

    <!-- 3. QR VIEW -->
    <div id="view-qr" class="page px-6 py-6 flex flex-col bg-gray-900 text-white">
        <div class="flex items-center mb-6">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-white active:scale-90 transition-transform"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2" id="qr-view-title">–ü–æ–∫–∞–∂–∏—Ç–µ –±–∞—Ä–∏—Å—Ç–∞</h2>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center">
            <div id="qr-view-hint" class="mb-6 px-4 py-2 bg-white/10 rounded-lg text-sm font-medium text-center backdrop-blur-md">...</div>
            <div class="bg-white p-5 rounded-3xl shadow-2xl mb-8 relative">
                <div id="qrcode"></div>
                <div id="qr-error-msg" class="hidden absolute inset-0 bg-white flex flex-col items-center justify-center text-red-500 text-center p-4"><p class="font-bold text-sm">–û—à–∏–±–∫–∞</p></div>
                <div id="qr-expired" class="hidden absolute inset-0 bg-white/95 flex flex-col items-center justify-center rounded-3xl text-center p-4">
                    <i data-lucide="refresh-cw" class="w-8 h-8 text-gray-400 mb-2"></i>
                    <p class="text-gray-900 font-bold mb-2">–ö–æ–¥ –∏—Å—Ç–µ–∫</p>
                    <button onclick="QRManager.generate()" class="text-theme text-sm font-bold">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>
            <div class="w-full max-w-[200px] h-1 bg-gray-800 rounded-full overflow-hidden"><div id="timer-bar" class="h-full bg-theme transition-all duration-1000 ease-linear" style="width: 100%"></div></div>
        </div>
    </div>

    <!-- 4. ADMIN VIEW (Dark Theme) -->
    <div id="view-admin" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center gap-2">
                <button onclick="Router.go('wallet')" class="p-2 -ml-2 text-gray-400 hover:text-gray-900"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h2 class="text-2xl font-bold text-gray-900">–ö–∞–±–∏–Ω–µ—Ç –í–ª–∞–¥–µ–ª—å—Ü–∞</h2>
            </div>
            <div class="px-3 py-1 bg-gray-100 rounded-full text-xs font-bold text-gray-500">OWNER</div>
        </div>
        <div class="bg-theme-soft border border-theme/20 rounded-2xl p-6 mb-6">
            <h3 class="text-theme-dark font-bold text-lg mb-1" id="admin-biz-name">...</h3>
            <p class="text-xs text-theme/80">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
        </div>
        <div class="grid gap-4">
            <button onclick="AdminManager.scan()" class="w-full py-5 bg-gray-900 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-3"><i data-lucide="scan-line" class="w-6 h-6"></i> –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ö–ª–∏–µ–Ω—Ç–∞</button>
            <button onclick="AdminManager.showInviteQR()" class="w-full py-5 bg-theme text-white font-bold rounded-2xl shadow-lg shadow-theme/30 active:scale-95 transition-transform flex items-center justify-center gap-3"><i data-lucide="qr-code" class="w-6 h-6"></i> QR –¥–ª—è –≤—Ö–æ–¥–∞</button>
            <button onclick="Router.go('admin-settings')" class="w-full py-5 bg-white border border-gray-200 text-gray-800 font-bold rounded-2xl shadow-sm active:scale-95 transition-transform flex items-center justify-center gap-3"><i data-lucide="settings" class="w-6 h-6 text-gray-400"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
        <div id="scan-status" class="mt-6 text-center h-6 text-sm font-medium"></div>
    </div>

    <!-- 5. SETTINGS VIEW -->
    <div id="view-admin-settings" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center mb-6">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900 active:scale-90 transition-transform"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        </div>
        <div class="space-y-6 flex-1 overflow-y-auto pb-10">
            <div><label class="block text-sm font-bold text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="setting-name" class="w-full p-4 bg-white border border-gray-200 rounded-xl focus:border-theme outline-none"></div>
            <div><label class="block text-sm font-bold text-gray-700 mb-2">Username –±–æ—Ç–∞</label><input type="text" id="setting-bot-username" class="w-full p-4 bg-white border border-gray-200 rounded-xl focus:border-theme outline-none"></div>
            <div><label class="block text-sm font-bold text-gray-700 mb-2">–¶–≤–µ—Ç</label><div class="flex items-center gap-4 bg-white p-2 rounded-xl border border-gray-200"><input type="color" id="setting-color" class="w-12 h-12 rounded-lg border-none bg-transparent"><span class="text-gray-500 font-mono text-sm" id="setting-color-hex"></span></div></div>
            <div><label class="block text-sm font-bold text-gray-700 mb-2">–¶–µ–ª—å</label><div class="grid grid-cols-3 gap-3"><button onclick="AdminManager.setTarget(6)" class="setting-target-btn p-3 rounded-xl border-2 font-bold" data-val="6">6</button><button onclick="AdminManager.setTarget(8)" class="setting-target-btn p-3 rounded-xl border-2 font-bold" data-val="8">8</button><button onclick="AdminManager.setTarget(10)" class="setting-target-btn p-3 rounded-xl border-2 font-bold" data-val="10">10</button></div></div>
            <div><label class="block text-sm font-bold text-gray-700 mb-2">–õ–æ–≥–æ—Ç–∏–ø URL</label><input type="url" id="setting-logo" class="w-full p-4 bg-white border border-gray-200 rounded-xl focus:border-theme outline-none"></div>
        </div>
        <button onclick="AdminManager.saveSettings()" class="w-full py-4 bg-gray-900 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- MODALS -->
    <div id="admin-invite-modal" class="hidden fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-6 fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center shadow-2xl relative">
            <button onclick="document.getElementById('admin-invite-modal').classList.add('hidden')" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-gray-900"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h3 class="text-xl font-bold text-gray-900 mb-4">QR –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
            <div id="invite-qrcode" class="flex justify-center mb-4"></div>
            <div class="bg-gray-50 p-3 rounded-xl text-xs text-gray-400 break-all font-mono mb-4" id="invite-link-text"></div>
        </div>
    </div>

    <!-- SUCCESS & CONFLICT Modals and Views assumed standard, keeping short for file limit but logic is in JS below -->
    <div id="view-success" class="page px-6 py-6 flex flex-col items-center justify-center bg-theme-soft">
        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mb-6 shadow-lg text-theme"><i data-lucide="check" class="w-12 h-12"></i></div>
        <h2 id="success-title" class="text-2xl font-black text-gray-900 mb-2">–û—Ç–ª–∏—á–Ω–æ!</h2>
        <p id="success-message" class="text-gray-600 text-center mb-12">...</p>
        <button onclick="Router.go('home')" class="w-full py-4 bg-white text-gray-900 font-bold rounded-xl shadow-sm">–í –º–µ–Ω—é</button>
    </div>

    <script>
        const API_BASE = 'https://n8n.inflio.xyz/webhook';
        const DEFAULT_BOT_USERNAME = 'SeldonLoyaltyBot'; 
        const tg = window.Telegram.WebApp;
        lucide.createIcons();

        const State = {
            user: null, mode: 'loading', wallets: [],
            config: { name: "Loading...", target_count: 6, theme_color: "#F59E0B", reward_name: "–ë–æ–Ω—É—Å", logo_url: "", currency_symbol: "‚≠êÔ∏è", bot_username: "" },
            balance: 0, bonusCups: 0, totalStamps: 0, businessId: null, currentSessionId: null, qrIntent: 'EARN', rank: 'Guest', tempTarget: 6, isAdmin: false
        };

        const Actions = {
            enterBusiness(walletItem) {
                State.businessId = walletItem.business_id;
                State.config = { name: walletItem.name, theme_color: walletItem.theme, logo_url: walletItem.logo, target_count: walletItem.target };
                State.balance = walletItem.balance;
                State.isAdmin = !!walletItem.is_owner;
                UIManager.applyTheme(State.config);
                Router.go(State.isAdmin ? 'admin' : 'home');
            }
        };

        const Router = {
            history: [],
            go(viewId, param = null) {
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                const target = document.getElementById(`view-${viewId}`);
                if(target) {
                    target.classList.add('active');
                    this.history.push(viewId);
                    if(viewId === 'qr') { State.qrIntent = param || 'EARN'; QRManager.generate(); UIManager.updateQRView(); }
                    if(viewId === 'home') UIManager.renderHome();
                    if(viewId === 'card') UIManager.renderCard();
                    if(viewId === 'bonuses') UIManager.renderBonuses();
                    if(viewId === 'wallet') UIManager.renderWallet();
                    if(viewId === 'admin-settings') AdminManager.initSettingsForm();
                }
                if(this.history.length > 1) tg.BackButton.show(); else tg.BackButton.hide();
                setTimeout(() => lucide.createIcons(), 50);
            },
            back() {
                if(this.history.length <= 1) return;
                this.history.pop();
                const prev = this.history[this.history.length - 1];
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${prev}`).classList.add('active');
                if(prev !== 'qr') QRManager.stop();
                if(this.history.length <= 1) tg.BackButton.hide();
            }
        };

        const API = {
            async request(endpoint, method = 'GET', body = null) {
                const headers = { 'Content-Type': 'application/json', 'X-Telegram-Auth': tg.initData || '' };
                const config = { method, headers };
                if (body && method !== 'GET') config.body = JSON.stringify(body);
                let url = `${API_BASE}/${endpoint}`;
                if (method === 'GET' && body) { url += `?${new URLSearchParams(body).toString()}`; }
                const res = await fetch(url, config);
                if (!res.ok) throw new Error(`API Error: ${res.status}`);
                return await res.json();
            },
            async initApp(startParam) { return await this.request('init-app', 'GET', { start_param: startParam }); },
            
            // [FIXED] Send flat structure: { name, config } instead of { settings: ... }
            async saveSettings(data) { return await this.request('save-settings', 'POST', data); },
            
            async getQR(intent) { return await this.request('get-qr', 'GET', { intent: intent, business_id: State.businessId }); },
            async checkStatus(sessionId) { return await this.request('check-status', 'GET', { session_id: sessionId }); },
            async scanQR(qrSession, action = null) {
                const body = { qr_session: qrSession }; if (action) body.action = action;
                return await this.request('scan-qr', 'POST', body);
            }
        };

        const UIManager = {
            applyTheme(cfg) {
                const root = document.documentElement;
                root.style.setProperty('--theme-color', cfg.theme_color || '#F59E0B');
                document.getElementById('app-title').innerText = cfg.name || 'Loyalty';
                document.getElementById('app-logo').src = cfg.logo_url || 'https://via.placeholder.com/100';
                document.getElementById('admin-biz-name').innerText = cfg.name || '–ë–∏–∑–Ω–µ—Å';
                tg.setHeaderColor(cfg.theme_color || '#F59E0B');
            },
            renderWallet() {
                const owners = State.wallets.filter(w => w.is_owner);
                const clients = State.wallets.filter(w => !w.is_owner);
                const ownerList = document.getElementById('wallet-list-owners');
                const clientList = document.getElementById('wallet-list-clients');
                
                ownerList.innerHTML = ''; clientList.innerHTML = '';
                document.getElementById('wallet-group-owners').classList.add('hidden');
                document.getElementById('wallet-group-clients').classList.add('hidden');
                document.getElementById('wallet-empty').classList.add('hidden');

                if(!State.wallets.length) { document.getElementById('wallet-empty').classList.remove('hidden'); return; }

                // [DESIGN] Dark for Owners, Light for Clients
                const render = (w, container, isOwner) => {
                    const el = document.createElement('div');
                    const bg = isOwner ? 'bg-gray-900 border-gray-800 text-white shadow-lg' : 'bg-white border-gray-100 text-gray-900 shadow-sm';
                    const txt = isOwner ? 'text-white' : 'text-gray-900';
                    const sub = isOwner ? 'text-gray-400' : 'text-gray-500';
                    const icn = isOwner ? 'bg-gray-800' : 'bg-gray-50';
                    
                    el.className = `p-4 rounded-2xl border ${bg} flex items-center justify-between active:scale-95 transition-transform cursor-pointer`;
                    el.onclick = () => Actions.enterBusiness(w);
                    el.innerHTML = `<div class="flex items-center gap-3">
                        <img src="${w.logo || ''}" class="w-12 h-12 rounded-full object-cover border ${isOwner ? 'border-gray-700' : 'border-gray-100'}">
                        <div><p class="font-bold ${txt} text-lg">${w.name}</p><p class="text-sm ${sub}">${w.balance}/${w.target}</p></div>
                    </div><div class="w-8 h-8 ${icn} rounded-full flex items-center justify-center"><i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i></div>`;
                    container.appendChild(el);
                };

                if(owners.length) { document.getElementById('wallet-group-owners').classList.remove('hidden'); owners.forEach(w => render(w, ownerList, true)); }
                if(clients.length) { document.getElementById('wallet-group-clients').classList.remove('hidden'); clients.forEach(w => render(w, clientList, false)); }
                lucide.createIcons();
            },
            renderHome() {
                document.getElementById('user-name').innerText = `–ü—Ä–∏–≤–µ—Ç, ${State.user.first_name}!`;
                document.getElementById('user-balance').innerText = State.balance;
                document.getElementById('target-count-display').innerText = State.config.target_count;
                document.getElementById('stamps-left').innerText = Math.max(0, State.config.target_count - State.balance);
                document.getElementById('reward-name-display').innerText = State.config.reward_name;
                const bonus = document.getElementById('home-bonus-count');
                bonus.innerText = State.bonusCups > 0 ? `–î–æ—Å—Ç—É–ø–Ω–æ: ${State.bonusCups}` : "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö";
                bonus.className = State.bonusCups > 0 ? 'text-theme font-bold' : 'text-gray-400';
                
                document.getElementById('btn-back-wallet').classList.toggle('hidden', State.mode !== 'wallet');
                document.getElementById('user-rank').innerText = State.totalStamps > 10 ? (State.totalStamps > 30 ? "VIP" : "–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π") : "–ù–æ–≤–∏—á–æ–∫";
            },
            renderBonuses() {
                document.getElementById('bonus-cups-display').innerText = State.bonusCups;
                const btn = document.getElementById('btn-use-bonus');
                btn.disabled = State.bonusCups <= 0;
                btn.classList.toggle('grayscale', State.bonusCups <= 0);
                btn.classList.toggle('opacity-50', State.bonusCups <= 0);
            },
            renderCard() {
                const grid = document.getElementById('stamps-container'); grid.innerHTML = '';
                for(let i=1; i<=State.config.target_count; i++) {
                    const active = i <= State.balance;
                    const el = document.createElement('div');
                    el.className = `w-16 h-16 rounded-full flex items-center justify-center text-xl font-bold border-4 transition-all ${active ? 'bg-theme-soft border-theme text-theme scale-105 shadow-md' : 'bg-gray-50 border-gray-100 text-gray-300'}`;
                    el.innerHTML = active ? State.config.currency_symbol : i;
                    grid.appendChild(el);
                }
            },
            updateQRView() {
                const isRedeem = State.qrIntent === 'REDEEM';
                document.getElementById('qr-view-title').innerText = isRedeem ? "–°–ø–∏—Å–∞–Ω–∏–µ –±–æ–Ω—É—Å–∞" : "–ö–æ–ø–∏–º –±–∞–ª–ª—ã";
                document.getElementById('qr-view-hint').innerText = isRedeem ? `–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è: ${State.config.reward_name}` : `–î–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è ${State.config.currency_symbol}`;
                document.getElementById('timer-bar').style.backgroundColor = "var(--theme-color)";
            }
        };

        const QRManager = {
            poll: null, timer: null,
            async generate() {
                document.getElementById('qr-expired').classList.add('hidden');
                document.getElementById('qr-error-msg').classList.add('hidden');
                document.getElementById('qrcode').innerHTML = '<div class="w-8 h-8 border-4 border-gray-200 border-t-gray-800 rounded-full animate-spin"></div>';
                
                try {
                    const data = await API.getQR(State.qrIntent);
                    const session = Array.isArray(data) ? data[0] : data;
                    if (!session || !session.session_id) throw new Error("No SID");
                    State.currentSessionId = session.session_id;

                    document.getElementById('qrcode').innerHTML = '';
                    new QRCode(document.getElementById("qrcode"), { text: JSON.stringify({ sid: session.session_id }), width: 200, height: 200 });
                    this.startTimer(); this.startPolling();
                } catch(e) {
                    document.getElementById('qrcode').innerHTML = '';
                    document.getElementById('qr-error-msg').classList.remove('hidden');
                }
            },
            startTimer() {
                let t = 300; const bar = document.getElementById('timer-bar');
                if(this.timer) clearInterval(this.timer);
                this.timer = setInterval(() => { t--; bar.style.width = `${(t/300)*100}%`; if(t<=0) { this.stop(); document.getElementById('qr-expired').classList.remove('hidden'); } }, 1000);
            },
            startPolling() {
                if(this.poll) clearInterval(this.poll);
                this.poll = setInterval(async () => {
                    try {
                        const data = await API.checkStatus(State.currentSessionId);
                        const status = Array.isArray(data) ? data[0] : data;
                        if(status.status === 'USED') {
                            this.stop();
                            State.balance = status.balance || 0; State.bonusCups = status.bonus_cups || 0;
                            document.getElementById('success-message').innerText = State.qrIntent === 'REDEEM' ? "–ë–æ–Ω—É—Å —Å–ø–∏—Å–∞–Ω!" : "–®—Ç–∞–º–ø –ø–æ–ª—É—á–µ–Ω!";
                            tg.HapticFeedback.notificationOccurred('success');
                            Router.go('success');
                        }
                    } catch(e) {}
                }, 2500);
            },
            stop() { clearInterval(this.poll); clearInterval(this.timer); }
        };

        const AdminManager = {
            initSettingsForm() {
                document.getElementById('setting-name').value = State.config.name;
                document.getElementById('setting-color').value = State.config.theme_color;
                document.getElementById('setting-color-hex').innerText = State.config.theme_color;
                document.getElementById('setting-logo').value = State.config.logo_url;
                document.getElementById('setting-bot-username').value = State.config.bot_username || '';
                this.setTarget(State.config.target_count || 6);
                document.getElementById('setting-color').oninput = (e) => document.getElementById('setting-color-hex').innerText = e.target.value;
            },
            setTarget(val) {
                State.tempTarget = val;
                document.querySelectorAll('.setting-target-btn').forEach(b => {
                    const active = parseInt(b.dataset.val) === val;
                    b.className = `setting-target-btn p-3 rounded-xl border-2 font-bold ${active ? 'border-theme text-theme bg-theme-soft' : 'border-gray-100 text-gray-400'}`;
                });
            },
            async saveSettings() {
                // [FIXED] Construct Flat Payload for v1 compatibility
                const payload = {
                    name: document.getElementById('setting-name').value,
                    config: {
                        theme_color: document.getElementById('setting-color').value,
                        target_count: State.tempTarget,
                        logo_url: document.getElementById('setting-logo').value,
                        bot_username: document.getElementById('setting-bot-username').value.trim()
                    }
                };
                try {
                    tg.MainButton.showProgress();
                    await API.saveSettings(payload);
                    State.config = { ...State.config, ...payload.config, name: payload.name };
                    UIManager.applyTheme(State.config);
                    tg.MainButton.hideProgress();
                    tg.HapticFeedback.notificationOccurred('success');
                    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); Router.back();
                } catch(e) { tg.MainButton.hideProgress(); alert("–û—à–∏–±–∫–∞"); }
            },
            scan() {
                tg.showScanQrPopup({ text: "–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–ª–∏–µ–Ω—Ç–∞" }, async (t) => {
                    tg.closeScanQrPopup();
                    try {
                        const sid = JSON.parse(t).sid;
                        const res = await API.scanQR(sid);
                        const r = Array.isArray(res) ? res[0].result : res.result;
                        tg.showAlert(r.message || "–û–∫");
                    } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞"); }
                    return true;
                });
            },
            showInviteQR() {
                const link = `https://t.me/${State.config.bot_username || DEFAULT_BOT_USERNAME}?startapp=${State.businessId}`;
                document.getElementById('invite-link-text').innerText = link;
                document.getElementById('invite-qrcode').innerHTML = '';
                new QRCode(document.getElementById("invite-qrcode"), { text: link, width: 200, height: 200 });
                document.getElementById('admin-invite-modal').classList.remove('hidden');
            }
        };

        async function bootstrap() {
            tg.expand(); tg.BackButton.onClick(() => Router.back());
            const user = tg.initDataUnsafe?.user;
            const startParam = tg.initDataUnsafe?.start_param || new URLSearchParams(window.location.search).get('startapp') || "";
            if (!user) { document.getElementById('loader').classList.add('hidden'); document.getElementById('stub-view').classList.remove('hidden'); return; }

            try {
                let res = await API.initApp(startParam);
                let data = Array.isArray(res) ? res[0] : res;
                if (data.data) data = data.data;

                State.user = user;
                if (data.mode === 'wallet') {
                    State.mode = 'wallet'; State.wallets = data.wallets;
                    document.getElementById('loader').classList.add('hidden');
                    if (State.wallets.length === 1 && !State.wallets[0].is_owner) { Actions.enterBusiness(State.wallets[0]); return; }
                    Router.go('wallet');
                } else {
                    State.mode = 'business'; State.businessId = data.business_id;
                    State.config = { ...data.business_config, name: data.business_name };
                    State.balance = data.balance; State.bonusCups = data.bonus_cups; State.totalStamps = data.total_stamps;
                    State.isAdmin = !!data.is_admin;
                    UIManager.applyTheme(State.config);
                    document.getElementById('loader').classList.add('hidden');
                    Router.go(State.isAdmin ? 'admin' : 'home');
                }
            } catch (e) { document.getElementById('loader').classList.add('hidden'); document.getElementById('view-error').classList.remove('hidden'); }
        }
        bootstrap();
    </script>
</body>
</html>


