<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coffee Bonus</title>
    
    <!-- Core Dependencies -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Icons (Lucide) for professional UI -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Base styles & Typography */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #F9FAFB;
        }

        /* Smooth Transitions */
        .page {
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1), opacity 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: #F9FAFB;
            display: none; /* Hidden by default */
        }
        
        .page.active {
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        /* Stamp Animation */
        .stamp-enter { animation: stamp-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes stamp-pop {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Modal Fade In */
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Custom Scrollbar hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-900 h-screen overflow-hidden relative">

    <!-- === LOADER === -->
    <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
        <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-gray-400 text-sm font-medium animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>

    <!-- === DESKTOP STUB === -->
    <div id="stub-view" class="hidden fixed inset-0 z-[60] bg-gray-50 flex flex-col items-center justify-center p-6 text-center">
        <i data-lucide="smartphone" class="w-16 h-16 text-gray-300 mb-4"></i>
        <h2 class="text-xl font-bold mb-2">–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</h2>
        <p class="text-gray-500">–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ Telegram.</p>
    </div>

    <!-- ================= VIEWS ================= -->

    <!-- 1. HOME VIEW (DASHBOARD) -->
    <div id="view-home" class="page px-5 py-6">
        <!-- User Header -->
        <header class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-2xl font-black text-gray-800 tracking-tight">COFFEE BONUS</h1>
                <p id="user-name" class="text-gray-500 font-medium">–ü—Ä–∏–≤–µ—Ç, –ì–æ—Å—Ç—å!</p>
            </div>
            <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden">
                <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
            </div>
        </header>

        <!-- Stats Card -->
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 text-white shadow-xl shadow-gray-200 mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <i data-lucide="coffee" class="w-24 h-24"></i>
            </div>
            
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">–í–∞—à —Å—Ç–∞—Ç—É—Å</p>
                        <p id="user-rank" class="text-2xl font-bold text-amber-400">–ù–æ–≤–∏—á–æ–∫</p>
                    </div>
                    <div class="text-right">
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-1">–ë–∞–ª–∞–Ω—Å</p>
                        <p class="text-2xl font-bold"><span id="user-balance">0</span><span class="text-gray-500 text-lg">/6</span></p>
                    </div>
                </div>

                <div class="bg-white/10 rounded-xl p-3 flex justify-between items-center backdrop-blur-sm">
                    <span class="text-sm font-medium">–î–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∫–æ—Ñ–µ:</span>
                    <span id="stamps-left" class="font-bold text-amber-400">6</span>
                </div>
            </div>
        </div>

        <!-- [NEW] Bonuses Button -->
        <button onclick="Router.go('bonuses')" class="w-full mb-6 py-4 bg-orange-50 border border-orange-100 rounded-2xl flex items-center justify-between px-6 shadow-sm active:scale-95 transition-transform group">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center shadow-lg shadow-orange-200">
                    <i data-lucide="gift" class="w-5 h-5"></i>
                </div>
                <div class="text-left">
                    <p class="font-bold text-gray-800">–ú–æ–∏ –±–æ–Ω—É—Å—ã</p>
                    <p class="text-xs text-orange-600 font-medium" id="home-bonus-count">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö</p>
                </div>
            </div>
            <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 group-hover:text-orange-500 transition-colors"></i>
        </button>

        <!-- Menu Grid -->
        <div class="grid grid-cols-2 gap-4">
            <button onclick="Router.go('card')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform">
                <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center">
                    <i data-lucide="credit-card" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-gray-700">–ú–æ—è –∫–∞—Ä—Ç–∞</span>
            </button>

            <!-- QR Action: Now explicitly 'EARN' -->
            <button onclick="Router.go('qr', 'EARN')" class="bg-blue-600 p-5 rounded-2xl shadow-lg shadow-blue-200 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform text-white">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                    <i data-lucide="qr-code" class="w-6 h-6"></i>
                </div>
                <span class="font-bold">–ü–æ–∫–∞–∑–∞—Ç—å QR</span>
            </button>

            <button onclick="Router.go('contacts')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform">
                <div class="w-12 h-12 bg-green-50 text-green-600 rounded-full flex items-center justify-center">
                    <i data-lucide="phone" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-gray-700">–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
            </button>

            <button onclick="Router.go('help')" class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform">
                <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-full flex items-center justify-center">
                    <i data-lucide="help-circle" class="w-6 h-6"></i>
                </div>
                <span class="font-bold text-gray-700">–ü–æ–º–æ—â—å</span>
            </button>
        </div>
        
        <div class="mt-8 text-center">
            <p class="text-xs text-gray-400">–í—Å–µ–≥–æ –≤—ã–ø–∏—Ç–æ –∫–æ—Ñ–µ: <span id="total-stamps" class="font-bold text-gray-600">0</span></p>
        </div>
    </div>

    <!-- [NEW] 2.1 BONUSES VIEW -->
    <div id="view-bonuses" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center mb-8">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900 active:scale-90 transition-transform">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="text-xl font-bold ml-2">–ú–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
        </div>

        <div class="flex-1 flex flex-col items-center">
            <!-- Rank Card Mini -->
            <div class="w-full bg-gray-900 text-white rounded-2xl p-6 shadow-xl mb-6 flex justify-between items-center">
                <div>
                    <p class="text-gray-400 text-xs mb-1">–í–∞—à —Å—Ç–∞—Ç—É—Å</p>
                    <h3 id="bonus-rank" class="text-2xl font-bold text-amber-400">–ù–æ–≤–∏—á–æ–∫</h3>
                </div>
                <div class="text-4xl">üèÜ</div>
            </div>

            <!-- Available Bonuses Big -->
            <div class="w-full bg-orange-50 border border-orange-100 rounded-3xl p-8 text-center mb-auto flex flex-col items-center justify-center">
                <div class="w-20 h-20 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="gift" class="w-10 h-10"></i>
                </div>
                <p class="text-orange-800 font-medium mb-2">–î–æ—Å—Ç—É–ø–Ω—ã–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –Ω–∞–ø–∏—Ç–∫–∏</p>
                <div class="text-6xl font-black text-orange-600 mb-4" id="bonus-cups-display">0</div>
                <p class="text-xs text-orange-400 max-w-[200px]">–ü–æ–∫–∞–∂–∏—Ç–µ QR –∫–æ–¥ —Å–ø–∏—Å–∞–Ω–∏—è –±–∞—Ä–∏—Å—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–ø–∏—Ç–æ–∫</p>
            </div>

            <!-- Use Bonus Button -->
            <button id="btn-use-bonus" onclick="Router.go('qr', 'REDEEM')" class="w-full py-4 bg-orange-500 text-white text-lg font-bold rounded-xl shadow-lg shadow-orange-200 active:scale-95 transition-transform disabled:opacity-50 disabled:grayscale flex items-center justify-center gap-2">
                <i data-lucide="qr-code" class="w-5 h-5"></i>
                –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å
            </button>
        </div>
    </div>

    <!-- 2. MY CARD VIEW (Existing) -->
    <div id="view-card" class="page px-6 py-6 flex flex-col">
        <div class="flex items-center mb-8">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900 active:scale-90 transition-transform">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="text-xl font-bold ml-2">–ë–æ–Ω—É—Å–Ω–∞—è –∫–∞—Ä—Ç–∞</h2>
        </div>

        <div class="bg-white rounded-3xl p-6 shadow-xl shadow-gray-100 border border-gray-100 flex-1 flex flex-col items-center">
            <div class="text-center mb-8">
                <h3 class="text-lg font-bold text-gray-800">–ö–∞–∂–¥–∞—è 6-—è —á–∞—à–∫–∞ ‚Äî –≤ –ø–æ–¥–∞—Ä–æ–∫!</h3>
                <p class="text-gray-400 text-sm mt-1">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–µ</p>
            </div>

            <div id="stamps-container" class="grid grid-cols-2 gap-6 w-full max-w-[240px] mb-auto">
                <!-- Stamps injected by JS -->
            </div>
            
            <button onclick="Router.go('qr', 'EARN')" class="w-full py-4 mt-8 bg-gray-900 text-white font-bold rounded-xl active:scale-95 transition-transform shadow-lg">
                –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å
            </button>
        </div>
    </div>

    <!-- 3. QR CODE VIEW -->
    <div id="view-qr" class="page px-6 py-6 flex flex-col bg-gray-900 text-white">
        <div class="flex items-center mb-6">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-white active:scale-90 transition-transform">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 class="text-xl font-bold ml-2" id="qr-view-title">–ü–æ–∫–∞–∂–∏—Ç–µ –±–∞—Ä–∏—Å—Ç–∞</h2>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center">
            <!-- Dynamic Hint -->
            <div id="qr-view-hint" class="mb-6 px-4 py-2 bg-white/10 rounded-lg text-sm font-medium text-center backdrop-blur-md">
                –î–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —à—Ç–∞–º–ø–∞
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-2xl mb-8 relative">
                <div id="qrcode"></div>
                <!-- Expired Overlay -->
                <div id="qr-expired" class="hidden absolute inset-0 bg-white/95 flex flex-col items-center justify-center rounded-3xl text-center p-4">
                    <i data-lucide="refresh-cw" class="w-8 h-8 text-gray-400 mb-2"></i>
                    <p class="text-gray-900 font-bold mb-2">–ö–æ–¥ –∏—Å—Ç–µ–∫</p>
                    <button onclick="QRManager.generate()" class="text-blue-600 text-sm font-bold">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            </div>

            <p class="text-gray-400 text-sm mb-4">–ö–æ–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
            
            <!-- Timer Bar -->
            <div class="w-full max-w-[200px] h-1 bg-gray-800 rounded-full overflow-hidden">
                <div id="timer-bar" class="h-full bg-blue-500 transition-all duration-1000 ease-linear" style="width: 100%"></div>
            </div>
        </div>
    </div>

    <!-- 4. SUCCESS VIEW -->
    <div id="view-success" class="page px-6 py-6 flex flex-col items-center justify-center bg-green-50">
        <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 stamp-enter">
            <i data-lucide="check" class="w-12 h-12 text-green-600"></i>
        </div>
        <h2 id="success-title" class="text-2xl font-black text-gray-900 mb-2">–û—Ç–ª–∏—á–Ω–æ!</h2>
        <p id="success-message" class="text-gray-600 text-center mb-12">–®—Ç–∞–º–ø —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à—É –∫–∞—Ä—Ç—É.</p>
        
        <div class="w-full space-y-3">
            <button onclick="Router.go('home')" class="w-full py-4 bg-white text-gray-900 font-bold rounded-xl border border-green-200 active:scale-95 transition-transform">
                –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            </button>
        </div>
    </div>

    <!-- 5. CONTACTS -->
    <div id="view-contacts" class="page px-6 py-6">
        <div class="flex items-center mb-8">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
        </div>
        <div class="space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                <div><p class="text-sm text-gray-400">–ê–¥—Ä–µ—Å</p><p class="font-bold">—É–ª. –õ–µ–Ω–∏–Ω–∞, 10</p></div>
            </div>
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4">
                <div class="w-10 h-10 bg-green-50 text-green-600 rounded-full flex items-center justify-center"><i data-lucide="phone" class="w-5 h-5"></i></div>
                <div><p class="text-sm text-gray-400">–¢–µ–ª–µ—Ñ–æ–Ω</p><p class="font-bold">+7 (999) 000-00-00</p></div>
            </div>
            <a href="https://t.me/support" class="block bg-blue-600 text-white p-4 rounded-xl text-center font-bold mt-8">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</a>
        </div>
    </div>

    <!-- 6. HELP -->
    <div id="view-help" class="page px-6 py-6">
        <div class="flex items-center mb-8">
            <button onclick="Router.back()" class="p-2 -ml-2 text-gray-400 hover:text-gray-900"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-bold ml-2">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</h2>
        </div>
        <div class="prose text-gray-600">
            <ul class="space-y-4">
                <li class="flex gap-3"><span class="font-bold text-gray-900">1.</span> –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∫ –Ω–∞–º –∑–∞ –∫–æ—Ñ–µ.</li>
                <li class="flex gap-3"><span class="font-bold text-gray-900">2.</span> –ù–∞–∂–º–∏—Ç–µ "–ü–æ–∫–∞–∑–∞—Ç—å QR" –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.</li>
                <li class="flex gap-3"><span class="font-bold text-gray-900">3.</span> –ü–æ–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –±–∞—Ä–∏—Å—Ç–∞.</li>
                <li class="flex gap-3"><span class="font-bold text-gray-900">4.</span> –ü–æ–ª—É—á–∏—Ç–µ —à—Ç–∞–º–ø. 6-–π –∫–æ—Ñ–µ ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ!</li>
            </ul>
        </div>
    </div>

    <!-- === ADMIN VIEW === -->
    <div id="view-admin" class="page px-6 py-6 flex flex-col items-center justify-center text-center">
        <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center mb-6 animate-pulse">
            <i data-lucide="scan-line" class="w-10 h-10 text-blue-600"></i>
        </div>
        <h2 class="text-2xl font-bold mb-2">–†–µ–∂–∏–º –°–∫–∞–Ω–µ—Ä–∞</h2>
        <p class="text-gray-500 mb-8">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</p>
        <button onclick="AdminManager.scan()" class="w-full max-w-xs py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
            <i data-lucide="camera" class="w-5 h-5"></i> –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR
        </button>
        <div id="scan-status" class="mt-4 h-6 text-sm font-medium"></div>
    </div>

    <!-- === ADMIN CONFLICT MODAL === -->
    <div id="admin-conflict-modal" class="hidden fixed inset-0 z-[70] bg-black/50 flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-circle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900">–í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è</h3>
                <p class="text-sm text-gray-500 mt-2">–ö–ª–∏–µ–Ω—Ç: <span id="conflict-username" class="font-bold text-gray-900">...</span></p>
                <p class="text-gray-600 mt-2 bg-amber-50 p-2 rounded-lg text-sm">–£ –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å –±–æ–Ω—É—Å—ã (<span id="conflict-bonus-count" class="font-bold"></span> —à—Ç).<br>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å?</p>
            </div>
            <div class="flex flex-col gap-3">
                <button onclick="AdminManager.resolve('EARN')" class="w-full py-3 bg-gray-100 text-gray-800 font-bold rounded-xl active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> –¢–æ–ª—å–∫–æ –Ω–∞–∫–æ–ø–∏—Ç—å
                </button>
                <button onclick="AdminManager.resolve('REDEEM')" class="w-full py-3 bg-orange-500 text-white font-bold rounded-xl shadow-lg shadow-orange-200 active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <i data-lucide="gift" class="w-4 h-4"></i> –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å
                </button>
            </div>
            <button onclick="AdminManager.closeConflict()" class="mt-4 text-sm text-gray-400 w-full text-center hover:text-gray-600">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const API_BASE = 'https://n8n.inflio.xyz/webhook';
        const tg = window.Telegram.WebApp;
        
        // --- INIT ICONS ---
        lucide.createIcons();

        // --- STATE ---
        const State = {
            user: null,
            balance: 0,
            bonusCups: 0, 
            totalStamps: 0,
            rank: '–ù–æ–≤–∏—á–æ–∫',
            currentSessionId: null,
            qrIntent: 'EARN' 
        };

        // --- ROUTER ---
        const Router = {
            history: [],
            
            go(viewId, param = null) {
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                
                const target = document.getElementById(`view-${viewId}`);
                if(target) {
                    target.classList.add('active');
                    this.history.push(viewId);
                    
                    if(viewId === 'qr') {
                        State.qrIntent = param || 'EARN'; 
                        QRManager.generate();
                        UIManager.updateQRView(); 
                    }
                    if(viewId === 'home') UIManager.updateHome();
                    if(viewId === 'card') UIManager.renderCard();
                    if(viewId === 'bonuses') UIManager.updateBonuses(); 
                }
                
                if(this.history.length > 1) tg.BackButton.show();
                else tg.BackButton.hide();
                
                setTimeout(() => lucide.createIcons(), 50);
            },

            back() {
                if(this.history.length <= 1) return;
                this.history.pop();
                const prev = this.history[this.history.length - 1];
                
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${prev}`).classList.add('active');
                
                if(prev !== 'qr') QRManager.stop();
                if(prev === 'home') UIManager.updateHome();
                
                if(this.history.length <= 1) tg.BackButton.hide();
            }
        };

        // --- API SECURITY LAYER ---
        const API = {
            // Centralized Request Handler with Auth Headers
            async request(endpoint, method = 'GET', body = null) {
                const headers = {
                    'Content-Type': 'application/json',
                    // üîí SECURITY: Send Telegram InitData in Header
                    'X-Telegram-Auth': tg.initData || ''
                };

                const config = { method, headers };
                if (body) config.body = JSON.stringify(body);

                // Build Query String if GET and params exist
                let url = `${API_BASE}/${endpoint}`;
                if (method === 'GET' && body) {
                    const params = new URLSearchParams(body).toString();
                    url += `?${params}`;
                    delete config.body;
                }

                try {
                    const res = await fetch(url, config);
                    if (!res.ok) throw new Error(`API Error: ${res.status}`);
                    return await res.json();
                } catch (e) {
                    console.error("Network Error:", e);
                    throw e;
                }
            },

            async initUser() {
                const u = tg.initDataUnsafe.user;
                // We still send query params for backward compatibility,
                // but the backend should ideally switch to using the Header.
                return await this.request('init-app', 'GET', { 
                    id: u.id, 
                    first_name: u.first_name 
                });
            },
            
            async getQR(userId, intent) {
                return await this.request('get-qr', 'GET', { 
                    user_id: userId, 
                    intent: intent 
                });
            },
            
            async checkStatus(sessionId) {
                return await this.request('check-status', 'GET', { 
                    session_id: sessionId 
                });
            },

            async scanQR(adminId, qrSession, action = null) {
                const body = { admin_id: adminId, qr_session: qrSession };
                if (action) body.action = action;
                return await this.request('scan-qr', 'POST', body);
            }
        };

        // --- UI MANAGER ---
        const UIManager = {
            updateHome() {
                document.getElementById('user-name').innerText = `–ü—Ä–∏–≤–µ—Ç, ${State.user.first_name || '–î—Ä—É–≥'}!`;
                document.getElementById('user-balance').innerText = State.balance;
                document.getElementById('stamps-left').innerText = 6 - State.balance;
                document.getElementById('total-stamps').innerText = State.totalStamps;
                
                const bonusText = document.getElementById('home-bonus-count');
                if (State.bonusCups > 0) {
                    bonusText.innerText = `–î–æ—Å—Ç—É–ø–Ω–æ: ${State.bonusCups} —à—Ç.`;
                    bonusText.classList.remove('text-gray-400');
                    bonusText.classList.add('text-orange-600', 'font-bold');
                } else {
                    bonusText.innerText = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö";
                    bonusText.classList.remove('text-orange-600', 'font-bold');
                    bonusText.classList.add('text-gray-400');
                }

                let rank = "–ù–æ–≤–∏—á–æ–∫";
                if(State.totalStamps > 10) rank = "–õ—é–±–∏—Ç–µ–ª—å";
                if(State.totalStamps > 30) rank = "–ö–æ—Ñ–µ–º–∞–Ω";
                if(State.totalStamps > 50) rank = "–ë–∞—Ä–∏—Å—Ç–∞";
                document.getElementById('user-rank').innerText = rank;
                State.rank = rank;
            },

            updateBonuses() {
                document.getElementById('bonus-rank').innerText = State.rank;
                document.getElementById('bonus-cups-display').innerText = State.bonusCups;
                
                const btn = document.getElementById('btn-use-bonus');
                if (State.bonusCups > 0) {
                    btn.disabled = false;
                    btn.classList.remove('grayscale');
                    btn.innerHTML = '<i data-lucide="qr-code" class="w-5 h-5"></i> –°–ø–∏—Å–∞—Ç—å –±–æ–Ω—É—Å';
                } else {
                    btn.disabled = true;
                    btn.classList.add('grayscale');
                    btn.innerText = "–ù–µ—Ç –±–æ–Ω—É—Å–æ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è";
                }
            },

            updateQRView() {
                const title = document.getElementById('qr-view-title');
                const hint = document.getElementById('qr-view-hint');
                const bar = document.getElementById('timer-bar');

                if (State.qrIntent === 'REDEEM') {
                    title.innerText = "–°–ø–∏—Å–∞–Ω–∏–µ –±–æ–Ω—É—Å–∞";
                    hint.innerText = "–°–ø–∏—Å–∞–Ω–∏–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –Ω–∞–ø–∏—Ç–∫–∞";
                    hint.className = "mb-6 px-4 py-2 bg-orange-500/20 text-orange-200 rounded-lg text-sm font-medium text-center backdrop-blur-md border border-orange-500/30";
                    bar.className = "h-full bg-orange-500 transition-all duration-1000 ease-linear";
                } else {
                    title.innerText = "–ü–æ–ª—É—á–µ–Ω–∏–µ —à—Ç–∞–º–ø–∞";
                    hint.innerText = "–î–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —à—Ç–∞–º–ø–∞";
                    hint.className = "mb-6 px-4 py-2 bg-white/10 text-white rounded-lg text-sm font-medium text-center backdrop-blur-md";
                    bar.className = "h-full bg-blue-500 transition-all duration-1000 ease-linear";
                }
            },

            renderCard() {
                const grid = document.getElementById('stamps-container');
                grid.innerHTML = '';
                for (let i = 1; i <= 6; i++) {
                    const isActive = i <= State.balance;
                    const el = document.createElement('div');
                    const baseClass = "aspect-square rounded-full flex items-center justify-center text-xl font-bold border-4 transition-all duration-300";
                    const activeClass = "bg-amber-100 border-amber-500 text-amber-600 scale-105 shadow-md";
                    const emptyClass = "bg-gray-50 border-gray-200 text-gray-300";
                    el.className = `${baseClass} ${isActive ? activeClass : emptyClass}`;
                    if (isActive) el.innerHTML = '<i data-lucide="coffee" class="w-8 h-8"></i>';
                    else el.innerText = i;
                    grid.appendChild(el);
                }
                lucide.createIcons();
            }
        };

        // --- QR LOGIC ---
        const QRManager = {
            pollInterval: null,
            timerInterval: null,
            
            async generate() {
                document.getElementById('qr-expired').classList.add('hidden');
                document.getElementById('qrcode').innerHTML = '';
                
                const loading = document.createElement('div');
                loading.className = "w-[200px] h-[200px] flex items-center justify-center";
                loading.innerHTML = '<div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>';
                document.getElementById('qrcode').appendChild(loading);

                try {
                    const data = await API.getQR(State.user.id, State.qrIntent);
                    const session = Array.isArray(data) ? data[0] : data;
                    State.currentSessionId = session.session_id;

                    document.getElementById('qrcode').innerHTML = '';
                    new QRCode(document.getElementById("qrcode"), {
                        text: JSON.stringify({ sid: session.session_id }),
                        width: 200,
                        height: 200,
                        colorDark : "#1F2937",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });

                    this.startTimer();
                    this.startPolling();
                } catch (e) {
                    console.error(e);
                    document.getElementById('qrcode').innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
                }
            },

            startTimer() {
                let timeLeft = 300;
                const bar = document.getElementById('timer-bar');
                if(this.timerInterval) clearInterval(this.timerInterval);
                
                this.timerInterval = setInterval(() => {
                    timeLeft--;
                    bar.style.width = `${(timeLeft/300)*100}%`;
                    if(timeLeft <= 0) {
                        this.stop();
                        document.getElementById('qr-expired').classList.remove('hidden');
                    }
                }, 1000);
            },

            startPolling() {
                if(this.pollInterval) clearInterval(this.pollInterval);
                this.pollInterval = setInterval(async () => {
                    try {
                        const data = await API.checkStatus(State.currentSessionId);
                        const statusData = Array.isArray(data) ? data[0] : data;
                        
                        if (statusData.status === 'USED') {
                            this.stop();
                            State.balance = statusData.balance || 0;
                            State.bonusCups = statusData.bonus_cups || 0;
                            State.totalStamps = (State.totalStamps || 0) + 1;

                            const title = document.getElementById('success-title');
                            const msg = document.getElementById('success-message');
                            
                            if (State.qrIntent === 'REDEEM') {
                                title.innerText = "–ë–æ–Ω—É—Å —Å–ø–∏—Å–∞–Ω!";
                                msg.innerText = "–ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –≤–∞—à–∏–º –∫–æ—Ñ–µ!";
                            } else if (statusData.balance === 0 && statusData.bonus_cups > 0) {
                                title.innerText = "üéâ –ù–æ–≤—ã–π –±–æ–Ω—É—Å!";
                                msg.innerText = "–í—ã –Ω–∞–∫–æ–ø–∏–ª–∏ 6 —à—Ç–∞–º–ø–æ–≤! –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–æ—Ñ–µ –¥–æ—Å—Ç—É–ø–µ–Ω.";
                            } else {
                                title.innerText = "–®—Ç–∞–º–ø –ø–æ–ª—É—á–µ–Ω!";
                                msg.innerText = `–î–æ –±–æ–Ω—É—Å–∞ –æ—Å—Ç–∞–ª–æ—Å—å: ${6 - statusData.balance}`;
                            }

                            tg.HapticFeedback.notificationOccurred('success');
                            Router.go('success');
                        }
                    } catch(e) { console.error("Poll error", e); }
                }, 2500);
            },

            stop() {
                clearInterval(this.pollInterval);
                clearInterval(this.timerInterval);
            }
        };

        // --- ADMIN MANAGER ---
        const AdminManager = {
            conflictSessionId: null,

            scan() {
                tg.showScanQrPopup({ text: "–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–ª–∏–µ–Ω—Ç–∞" }, async (qrText) => {
                    tg.closeScanQrPopup(); 
                    
                    const statusEl = document.getElementById('scan-status');
                    statusEl.innerHTML = '<span class="text-blue-600 animate-pulse">–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>';
                    
                    try {
                        let parsed;
                        try { parsed = JSON.parse(qrText); } catch(e) { throw new Error("Invalid JSON"); }
                        if (!parsed.sid) throw new Error("No SID");
                        
                        const res = await API.scanQR(State.user.id, parsed.sid);
                        const result = Array.isArray(res) ? res[0].result : res.result; 

                        if (result.status === 'success') {
                            tg.HapticFeedback.notificationOccurred('success');
                            tg.showAlert(result.message);
                            statusEl.innerHTML = '<span class="text-green-600 font-bold">‚úÖ –£—Å–ø–µ—à–Ω–æ</span>';
                        } 
                        else if (result.status === 'confirmation_required') {
                            this.conflictSessionId = result.session_id;
                            document.getElementById('conflict-username').innerText = result.user_name || '–ö–ª–∏–µ–Ω—Ç';
                            document.getElementById('conflict-bonus-count').innerText = result.bonus_cups;
                            document.getElementById('admin-conflict-modal').classList.remove('hidden');
                            
                            tg.HapticFeedback.notificationOccurred('warning');
                            statusEl.innerHTML = '<span class="text-amber-500 font-bold">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–±–æ—Ä</span>';
                        }
                        else {
                            tg.HapticFeedback.notificationOccurred('error');
                            tg.showAlert(`–û—à–∏–±–∫–∞: ${result.message}`);
                            statusEl.innerHTML = '<span class="text-red-500 font-bold">‚ùå –û—à–∏–±–∫–∞</span>';
                        }
                    } catch (e) {
                        tg.showAlert("–ù–µ–≤–µ—Ä–Ω—ã–π QR –∫–æ–¥");
                        statusEl.innerHTML = '<span class="text-red-500">–ù–µ–≤–µ—Ä–Ω—ã–π QR</span>';
                    }
                    return true;
                });
            },

            async resolve(action) {
                this.closeConflict();
                const statusEl = document.getElementById('scan-status');
                statusEl.innerHTML = '<span class="text-blue-600 animate-pulse">–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ...</span>';

                try {
                    const res = await API.scanQR(State.user.id, this.conflictSessionId, action);
                    const result = Array.isArray(res) ? res[0].result : res.result;

                    if (result.status === 'success') {
                        tg.showAlert(result.message);
                        statusEl.innerHTML = '<span class="text-green-600 font-bold">‚úÖ –£—Å–ø–µ—à–Ω–æ</span>';
                    } else {
                        tg.showAlert(`–û—à–∏–±–∫–∞: ${result.message}`);
                        statusEl.innerHTML = '<span class="text-red-500">–û—à–∏–±–∫–∞</span>';
                    }
                } catch (e) {
                    tg.showAlert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                }
            },

            closeConflict() {
                document.getElementById('admin-conflict-modal').classList.add('hidden');
                this.conflictSessionId = null;
            }
        };

        // --- INIT ---
        async function initApp() {
            tg.expand();
            tg.BackButton.onClick(() => Router.back());

            const u = tg.initDataUnsafe?.user;
            
            if (!u || !u.id) {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('stub-view').classList.remove('hidden');
                return;
            }

            try {
                const data = await API.initUser();
                const userData = Array.isArray(data) ? data[0] : data;
                
                State.user = u;
                State.balance = userData.balance || 0;
                State.bonusCups = userData.bonus_cups || 0; 
                State.totalStamps = userData.total_stamps || 0;
                
                document.getElementById('loader').classList.add('hidden');
                
                if (userData.is_admin) {
                    Router.go('admin');
                } else {
                    Router.go('home');
                }
            } catch (e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
            }
        }

        initApp();
    </script>
</body>
</html>
